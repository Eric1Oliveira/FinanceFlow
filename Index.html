<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FinanceFlow - Controle Financeiro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
        const SUPABASE_URL = 'https://tcxfchhkrfrzcbafuesy.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRjeGZjaGhrcmZyemNiYWZ1ZXN5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3OTAzODksImV4cCI6MjA2OTM2NjM4OX0.jT2EFI-aPYigCH-mX73Kec7lCZ-f2KF9oOoH-bvt4lU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    </script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#eff6ff',
                            500: '#3b82f6',
                            600: '#2563eb',
                            700: '#1d4ed8',
                            900: '#1e3a8a'
                        },
                        success: {
                            500: '#10b981',
                            600: '#059669'
                        },
                        danger: {
                            500: '#ef4444',
                            600: '#dc2626'
                        },
                        warning: {
                            500: '#f59e0b',
                            600: '#d97706'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.6s ease-out',
                        'pulse-slow': 'pulse 3s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' }
                        },
                        slideIn: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(0)' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>

        @media (max-width: 768px) {
        header {
            position: sticky; /* ou fixed, dependendo do efeito que quer */
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000; /* para ficar sobre outros elementos */
            background-color: white; /* importante para nÃ£o ficar transparente */
            /* Se usa dark mode, pode usar variÃ¡veis ou classes para o bg */
        }
        }

        /* Esconde o botÃ£o do header em telas pequenas */
        @media (max-width: 768px) {
        #addTransactionBtn {
            display: none;
        }
        #addTransactionFab {
            display: flex; /* mostrar o FAB */
        }
        }

        /* Em telas grandes, o contrÃ¡rio */
        @media (min-width: 769px) {
        #addTransactionBtn {
            display: inline-flex; /* mostrar botÃ£o no header */
        }
        #addTransactionFab {
            display: none; /* esconder o FAB */
        }
        }

        #loginModal, 
        #registerModal {
            min-height: 100vh;
            min-width: 100vw;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e293b 0%, #2563eb 100%) !important;
            background-size: cover;
            background-repeat: no-repeat;
            z-index: 1000;
            animation: fadeInBg 0.7s;
            display: none; /* sÃ³ aparece com .flex */
        }
        @keyframes fadeInBg {
            from { opacity: 0; }
            to { opacity: 1; }
        }

       #loginModal.flex, #registerModal.flex {
            display: flex !important;
        }

        /* Glass effect no card */
        .login-glass {
            backdrop-filter: blur(18px) saturate(120%);
            background: rgba(255,255,255,0.92) !important;
            border-radius: 1.25rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
            border: 2px solid #2563eb !important;
            transition: box-shadow 0.3s;
            color: #1e293b !important;
        }
        .dark .login-glass {
            background: rgba(30,41,59,0.98) !important; /* vidro mais escuro e opaco */
            border: 2px solid #60a5fa !important; /* borda azul clara */
            color: #f9fafb !important;
        }

        /* Inputs: borda e foco mais visÃ­veis */
        #loginModal input, #loginModal select, #loginModal textarea,
        #registerModal input, #registerModal select, #registerModal textarea {
            border: 2px solid #2563eb !important;
            background-color: #fff !important;
            color: #1e293b !important;
        }
        #loginModal input:focus, #loginModal select:focus, #loginModal textarea:focus,
        #registerModal input:focus, #registerModal select:focus, #registerModal textarea:focus {
            border-color: #1e293b !important;
            background-color: #f1f5f9 !important;
            color: #1e293b !important;
        }
        .dark #loginModal input, .dark #loginModal select, .dark #loginModal textarea,
        .dark #registerModal input, .dark #registerModal select, .dark #registerModal textarea {
            border: 2px solid #60a5fa !important;
            background-color: #1e293b !important;
            color: #f9fafb !important;
        }
        .dark #loginModal input:focus, .dark #loginModal select:focus, .dark #loginModal textarea:focus,
        .dark #registerModal input:focus, .dark #registerModal select:focus, .dark #registerModal textarea:focus {
            border-color: #f9fafb !important;
            background-color: #334155 !important;
            color: #f9fafb !important;
        }

        /* Links de aÃ§Ã£o: azul forte */
        .text-primary-600, .dark .text-primary-600 {
            color: #2563eb !important;
            font-weight: bold;
        }
        .text-primary-600:hover, .dark .text-primary-600:hover {
            color: #1e40af !important;
            text-decoration: underline;
        }

        /* Erros: vermelho forte */
        .text-red-500, .dark .text-red-500 {
            color: #dc2626 !important;
            font-weight: bold;
            background: #fff0f0 !important;
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Cards e tabelas: fundo mais branco/escuro e borda mais forte */
        .custom-card.bg-white {
            background-color: #fff !important;
            border: 2px solid #1e293b !important;
        }
        .dark .custom-card.bg-gray-800 {
            background-color: #1e293b !important;
            border: 2px solid #60a5fa !important;
        }

        /* Textos principais sÃ³ em cards customizados */
        .custom-card .text-gray-900, .dark .custom-card .text-gray-100 {
            color: #1e293b !important;
            font-weight: bold;
        }
        .dark .custom-card .text-gray-100 {
            color: #f9fafb !important;
        }

        /* Textos secundÃ¡rios sÃ³ em cards customizados */
        .custom-card .text-gray-600, .dark .custom-card .text-gray-400 {
            color: #334155 !important;
        }
        .dark .custom-card .text-gray-400 {
            color: #cbd5e1 !important;
        }

        /* AnimaÃ§Ã£o de entrada */
        @keyframes popIn {
            from { transform: scale(0.95) translateY(40px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        .login-glass {
            animation: popIn 0.5s cubic-bezier(.4,2,.3,1) 0.1s both;
        }

        body.login-active #appRoot {
            display: none !important;
        }

        input:focus, 
        input:active, 
        input:focus-visible {
            background-color: #fff !important;
            color: #222 !important;
        }
        .dark input:focus, 
        .dark input:active, 
        .dark input:focus-visible {
            background-color: #1f2937 !important;
            color: #e5e7eb !important;
        }
        
        /* Manual dark mode override */
        html.dark {
            color-scheme: dark;
        }
        
        html.light {
            color-scheme: light;
        }
        
        /* Smooth transitions for theme changes */
        * {
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .dark .glass-effect {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Theme toggle button animations */
        .theme-toggle-icon {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        
        .theme-toggle-icon.rotate {
            transform: rotate(180deg);
        }
        
        /* Navigation styles */
        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            text-decoration: none;
            border-radius: 0.5rem;
            transition: all 0.2s;
            color: #6b7280;
        }
        
        .dark .nav-link {
            color: #9ca3af;
        }
        
        .nav-link:hover {
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .dark .nav-link:hover {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .nav-link.active {
            background-color: rgba(59, 130, 246, 0.1);
            color: #2563eb;
            border-right: 2px solid #2563eb;
        }
        
        .dark .nav-link.active {
            background-color: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-right-color: #60a5fa;
        }

        /* Tema claro (padrÃ£o) */
        :root {
        --text-color: #222222; /* preto escuro */
        --tooltip-bg: #f9fafb; /* cinza claro */
        --tooltip-title: #111111; /* quase preto */
        --tooltip-text: #333333; /* cinza escuro */
        --grid-color: #e5e7eb; /* cinza claro */
        --bg-color: #ffffff; /* branco */
        }

        /* Tema escuro */
        .dark {
        --text-color: #e5e7eb; /* cinza claro */
        --tooltip-bg: #111827; /* quase preto */
        --tooltip-title: #f9fafb; /* branco quase */
        --tooltip-text: #d1d5db; /* cinza claro */
        --grid-color: #374151; /* cinza escuro */
        --bg-color: #1f2937; /* cinza muito escuro */
        }

        @keyframes bounceIn {
            0% { transform: scale(0.8); opacity: 0; }
            60% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        .animate-bounce-in {
            animation: bounceIn 0.5s;
        }

    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-100 dark:text-gray-900 transition-colors duration-300 login-active">
    
    
    <div id="loginModal" class="fixed inset-0 flex items-center justify-center z-50">
        <div class="login-glass w-full max-w-sm p-8">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Entrar</h2>
            <form id="loginForm" class="space-y-4">
                <input type="email" id="loginEmail" placeholder="E-mail" required class="w-full px-3 py-2 border rounded" />
                <input type="password" id="loginPassword" placeholder="Senha" required class="w-full px-3 py-2 border rounded" />
                <button type="submit" class="w-full bg-primary-600 text-white py-2 rounded hover:bg-primary-700">Entrar</button>
            </form>
            <div id="loginError" class="text-red-500 mt-2 text-sm hidden"></div>
            <div class="mt-4 text-center">
                <button id="openRegisterBtn" class="text-primary-600 hover:underline">Criar nova conta</button>
            </div>
        </div>
    </div>

    <!-- Modal de Cadastro -->
    <div id="registerModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="login-glass w-full max-w-sm p-8">
            <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-gray-100">Criar Conta</h2>
            <form id="registerForm" class="space-y-4">
                <input type="text" id="registerName" placeholder="Nome de usuÃ¡rio" required class="w-full px-3 py-2 border rounded" />
                <input type="email" id="registerEmail" placeholder="E-mail" required class="w-full px-3 py-2 border rounded" />
                <input type="password" id="registerPassword" placeholder="Senha" required minlength="6" class="w-full px-3 py-2 border rounded" />
                <input type="password" id="registerPasswordConfirm" placeholder="Confirme a senha" required minlength="6" class="w-full px-3 py-2 border rounded" />
                <button type="submit" class="w-full bg-primary-600 text-white py-2 rounded hover:bg-primary-700">Cadastrar</button>
            </form>
            <div id="registerError" class="text-red-500 mt-2 text-sm hidden"></div>
            <div class="mt-4 text-center">
                <button id="backToLoginBtn" type="button" class="text-primary-600 hover:underline">JÃ¡ tenho conta</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <div id="appRoot">
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <nav id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex flex-col h-full">
                <!-- Logo -->
                <div class="flex items-center justify-between p-6 border-b border-gray-200 dark:border-gray-700">
                    <h1 class="text-xl font-bold text-gray-900 dark:text-gray-100">FinanceFlow</h1>
                    <button id="closeSidebar" class="lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Navigation Menu -->
                <nav class="flex-1 px-4 py-6 space-y-2 overflow-y-auto scrollbar-hide">
                    <a href="#" class="nav-link active" data-section="dashboard">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        </svg>
                        <span>Dashboard</span>
                    </a>
                    <a href="#" class="nav-link" data-section="transactions">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <span>TransaÃ§Ãµes</span>
                    </a>
                    <a href="#" class="nav-link" data-section="budgets">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>OrÃ§amentos</span>
                    </a>
                    <a href="#" class="nav-link" data-section="goals">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        <span>Metas</span>
                    </a>
                    <a href="#" class="nav-link" data-section="reports">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span>RelatÃ³rios</span>
                    </a>
                    <a href="#" class="nav-link" data-section="categories">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                        <span>Categorias</span>
                    </a>
                </nav>
                <div class="mt-auto px-4 pb-6">
                    <div id="sidebarProfileBtn" class="flex items-center gap-3 p-2 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition relative group">
                        <div id="sidebarProfileAvatar" class="w-10 h-10 flex items-center justify-center rounded-full bg-primary-600 text-white text-lg font-bold"></div>
                        <div>
                            <div id="sidebarProfileName" class="font-medium text-gray-900 dark:text-gray-100 truncate max-w-[120px]"></div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Meu perfil</div>
                        </div>
                        <!-- Dropdown -->
                        <div id="sidebarProfileDropdown" class="hidden absolute bottom-14 left-0 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 z-50 animate-slide-up">
                            <button id="profileSettingsBtn" class="w-full flex items-center gap-2 px-4 py-3 text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                ConfiguraÃ§Ãµes
                            </button>
                            <button id="profileLogoutBtn" class="w-full flex items-center gap-2 px-4 py-3 text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900 transition text-left">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"></path></svg>
                                Sair
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"></div>

        <!-- Main Content -->
        <main class="w-full mx-auto sm:px-1 lg:px-1 lg:ml-64 ">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <button id="menuToggle" class="text-gray-800 dark:text-white lg:hidden p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors mr-4">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                        <h1 id="pageTitle" class="text-2xl font-semibold text-gray-900 dark:text-gray-100">Dashboard</h1>
                    </div>
                    <div class="flex items-center space-x-4">

                        <!-- Sync Status -->
                        <div id="syncStatus" class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                        </div>
                        
                        <!-- BotÃ£o do header (visÃ­vel sÃ³ md pra cima) -->
                        <button id="addTransactionBtn" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200 transform hover:scale-105">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                            <span>Nova TransaÃ§Ã£o</span>
                        </button>

                        <div class="space-y-2">
                            <button id="themeToggle" class="w-full flex items-center justify-center px-2 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition-all duration-300">
                                <svg id="themeIcon" class="theme-toggle-icon w-6 h-5 mr-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </header>


            <!-- FAB para celular (visÃ­vel sÃ³ em telas pequenas) -->
            <button id="addTransactionFab" aria-label="Nova TransaÃ§Ã£o" class="fixed bottom-6 right-6 w-14 h-14 rounded-full bg-primary-600 text-white shadow-lg flex items-center justify-center hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 hidden">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </button>

            <!-- Content Area -->
            <div class="mt-4">
                <!-- Dashboard Section -->
                <section id="dashboard-section" class="space-y-8 animate-fade-in">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-4 mb-10">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 ">
                            <div class="flex items-center justify-between">
                                <div class="flex flex-col">
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Saldo Atual</p>
                                    <div class="flex items-center">
                                        <p id="currentBalance" class="text-2xl font-bold text-green-600 dark:text-green-400"></p>
                                        <button id="editBalanceBtn" class="ml-2 p-2 rounded-full hover:bg-blue-100 dark:hover:bg-blue-900 transition" title="Editar saldo">
                                            <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 3.487a2.25 2.25 0 113.182 3.182l-11.25 11.25a2 2 0 01-.878.513l-4 1a1 1 0 001.212 1.212l1-4a2 2 0 01.513-.878l11.25-11.25z" />
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-1.5 bg-green-100 dark:bg-green-900 rounded-full">
                                    <svg class="w-9 h-9 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-sm">
                                <span id="balanceChange" class="text-green-600 dark:text-green-400 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                    </svg>
                                </span>
                                <span class="text-gray-600 dark:text-gray-400 ml-2">este mÃªs</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Receitas do MÃªs</p>
                                    <p id="monthlyIncome" class="text-2xl font-bold text-blue-600 dark:text-blue-400"></p>
                                </div>
                                <div class="p-3 bg-blue-100 dark:bg-blue-900 rounded-full">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="mt-4 flex items-center text-sm">
                                <span id="incomeChange" class="text-green-600 dark:text-green-400 flex items-center">
                                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path>
                                    </svg>
                                </span>
                                <span class="text-gray-600 dark:text-gray-400 ml-2">vs mÃªs anterior</span>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 ">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-sm font-medium text-gray-600 dark:text-gray-400">Despesas do MÃªs</p>
                                        <p id="monthlyExpenses" class="text-2xl font-bold text-red-600 dark:text-red-400"></p>
                                    </div>
                                    <div class="p-3 bg-red-100 dark:bg-red-900 rounded-full">
                                        <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="mt-4 flex items-center text-sm">
                                    <span id="expenseChange" class="text-red-600 dark:text-red-400 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path>
                                        </svg>
                                    </span>
                                    <span class="text-gray-600 dark:text-gray-400 ml-2">vs mÃªs anterior</span>
                                </div>
                            </div>
                        </div>

                        <!-- 2. GrÃ¡ficos lado a lado em telas grandes -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8 w-full">

                            <!-- Chart 1 - Receitas vs Despesas -->
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 w-full min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Receitas vs Despesas</h3>
                                <div class="h-64 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center w-full">
                                    <canvas id="incomeExpenseChart" class="w-full h-full"></canvas>
                                </div>
                            </div>

                            <!-- Chart 2 - Gastos por Categoria -->
                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6 w-full min-w-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Gastos por Categoria</h3>
                                <div class="h-64 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center w-full p-2">
                                    <canvas id="categoryChart" class="w-full h-full"></canvas>
                                </div>
                             </div>
                        </div>

                            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">TransaÃ§Ãµes Recentes</h3>
                                </div>

                                <div class="p-6 space-y-4">
                                    <!-- Tabela (aparece em md e acima) -->
                                    <div id="recentTransactionsTable" class="hidden md:block overflow-x-auto"></div>

                                    <!-- Cards (sÃ³ mobile) -->
                                    <div id="recentTransactionsCards" class="block md:hidden space-y-4"></div>
                                </div>
                            </div>
                        </div>
                </section>

                <!-- Transactions Section -->
                <section id="transactions-section" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                        <!-- Filters -->
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Todas as TransaÃ§Ãµes</h3>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                                    <input type="text" id="searchTransactions" placeholder="Buscar transaÃ§Ãµes..." class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <select id="filterCategory" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="">Todas as categorias</option>
                                    </select>
                                    <select id="filterType" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="">Todos os tipos</option>
                                        <option value="income">Receita</option>
                                        <option value="expense">Despesa</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="transactionsPagination" class="px-6 py-4 border-t border-gray-200 dark:border-gray-700"></div>
                    </div>

                    <div class=" mt-6 space-y-4">
                        <div id="transactionsTable" class="hidden md:block overflow-x-auto"></div>
                        <div id="transactionsCards" class="block md:hidden space-y-4"></div>
                    </div>
                </section>

                <!-- Budgets Section -->
                <section id="budgets-section" class="hidden">
                    <div id="budgetsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <!-- Goals Section -->
                <section id="goals-section" class="hidden">
                    <div id="goalsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <!-- Reports Section -->
                <section id="reports-section" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">EvoluÃ§Ã£o Mensal</h3>
                            <div class="h-64 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                <canvas id="monthlyChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">DistribuiÃ§Ã£o por Categoria</h3>
                            <div class="h-64 bg-gray-50 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                <canvas id="distributionChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Exportar Dados</h3>
                            <div class="flex space-x-2 mt-4 sm:mt-0">
                                <button onclick="app.exportToPDF()" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                                    Exportar PDF
                                </button>
                                <button onclick="app.exportToCSV()" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                    Exportar CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="categories-section" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-6">Categorias</h3>
                    </div>
                    <div id="categoriesGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                </section>
                

                <!-- Settings Section -->
                <section id="settings-section" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">PreferÃªncias Gerais</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Moeda PadrÃ£o</label>
                                    <select id="defaultCurrency" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="BRL">ðŸ‡§ðŸ‡· Real Brasileiro (R$)</option>
                                        <option value="USD">ðŸ‡ºðŸ‡¸ DÃ³lar Americano ($)</option>
                                        <option value="EUR">ðŸ‡ªðŸ‡º Euro (â‚¬)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Idioma</label>
                                    <select id="settingsLanguage" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="pt-BR">ðŸ‡§ðŸ‡· PortuguÃªs (Brasil)</option>
                                        <option value="en-US">ðŸ‡ºðŸ‡¸ English (US)</option>
                                        <option value="es-ES">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tema</label>
                                    <select id="themeSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                        <option value="auto">AutomÃ¡tico</option>
                                        <option value="light">Claro</option>
                                        <option value="dark">Escuro</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">NotificaÃ§Ãµes</h3>
                            <div class="space-y-4">
                                <label class="flex items-center">
                                    <input type="checkbox" id="budgetAlerts" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Alertas de orÃ§amento</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="goalReminders" checked class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Lembretes de metas</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" id="monthlyReports" class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">RelatÃ³rios mensais</span>
                                </label>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Gerenciamento de Dados</h3>
                            <div class="space-y-4">
                                <button id="importDataBtn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                    </svg>
                                    <span>Importar Dados</span>
                                </button>
                                <button id="exportAllDataBtn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <span>Exportar Todos os Dados</span>
                                </button>
                                <button id="clearAllDataBtn" class="w-full inline-flex items-center justify-center px-4 py-2 border border-red-300 dark:border-red-600 text-sm font-medium rounded-md text-red-700 dark:text-red-400 bg-white dark:bg-gray-700 hover:bg-red-50 dark:hover:bg-red-900 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                    <span>Limpar Todos os Dados</span>
                                </button>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">SeguranÃ§a</h3>
                            <div class="space-y-4">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Criptografia de dados</span>
                                    <span class="text-sm text-green-600 dark:text-green-400 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>Ativo</span>
                                    </span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-700 dark:text-gray-300">Backup automÃ¡tico</span>
                                    <span class="text-sm text-green-600 dark:text-green-400 flex items-center">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                        <span>Ativo</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-6 flex justify-end">
                        <button id="saveSettingsBtn" class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                            <span>Salvar ConfiguraÃ§Ãµes</span>
                        </button>
                    </div>
                </section>
            </div>
        </main>
    </div>
    </div>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>
    
    <script>
        // Global Application State
        class FinanceApp {
            constructor() {
                this.currentLanguage = localStorage.getItem('language') || 'pt-BR';
                this.currentTheme = localStorage.getItem('theme') || 'auto';
                this.currentSection = 'dashboard';
                this.renderCurrentSection();
                this.currentPage = 1;
                this.itemsPerPage = 10;
                
                // Data storage
                this.transactions = [];
                this.budgets = []
                this.goals = [];

                this.budgets = [];
                this.fetchBudgetsFromSupabase().then(budgets => {
                    this.budgets = budgets;
                    this.renderBudgets();
                });

                this.fetchTransactionsFromSupabase().then(transactions => {
                    this.transactions = transactions;
                    this.renderDashboard();
                });

                this.fetchGoalsFromSupabase().then(goals => {
                    this.goals = goals;
                    this.renderGoals();
                });
                            
                // Validation rules
                this.validationRules = {
                    transaction: {
                        amount: { required: true, min: 0.01, max: 999999.99 },
                        description: { required: true, minLength: 3, maxLength: 100 },
                        category: { required: true },
                        type: { required: true, enum: ['income', 'expense'] },
                        date: { required: true }
                    },
                    budget: {
                        category: { required: true },
                        limit: { required: true, min: 0.01, max: 999999.99 },
                        period: { required: true, enum: ['weekly', 'monthly', 'yearly'] }
                    },
                    goal: {
                        name: { required: true, minLength: 3, maxLength: 50 },
                        target: { required: true, min: 0.01, max: 9999999.99 },
                        current: { min: 0, max: 9999999.99 },
                        deadline: { required: true }
                    }
                };
                
                this.init();
            }
            async addBudgetToSupabase(budget) {
                const { id, createdAt, ...budgetData } = budget;
                const { data, error } = await supabase.from('budgets').insert([budgetData]).select();
                if (error) {
                    this.showNotification('Erro ao salvar orÃ§amento no servidor', 'error');
                    return false;
                }
                return { data }; // Retorne o objeto retornado pelo Supabase
            }

            async fetchTransactionsFromSupabase() {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return [];
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', user.id) // <-- filtra pelo usuÃ¡rio logado
                    .order('date', { ascending: false });
                if (error) {
                    this.showNotification('Erro ao carregar transaÃ§Ãµes do servidor', 'error');
                    return [];
                }
                return data || [];
            }

            // ...dentro da classe FinanceApp...
            openEditBalanceModal() {
                const modalId = 'editBalanceModal';
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-sm w-full mx-4 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Editar Saldo Atual</h3>
                        <form id="editBalanceForm" class="space-y-4">
                            <input type="number" name="amount" step="0.01" min="0" required class="w-full px-3 py-2 border rounded" placeholder="Novo saldo" />
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border rounded hover:bg-gray-50 dark:hover:bg-gray-600">Cancelar</button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded hover:bg-primary-700">Salvar</button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modalsContainer').appendChild(modal);

                modal.querySelector('#editBalanceForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amount = parseFloat(e.target.amount.value);
                    if (isNaN(amount)) return;
                    await this.saveBalanceToSupabase(amount);
                    this.closeModal(modalId);
                    this.renderDashboard();
                    this.showNotification('Saldo atualizado!', 'success');
                });
            }

            // ...dentro da classe FinanceApp...
            async fetchBalanceFromSupabase() {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return 0;
                const { data, error } = await supabase
                    .from('balances')
                    .select('amount,updated_at')
                    .eq('user_id', user.id)
                    .order('updated_at', { ascending: false })
                    .limit(1);
                if (error || !data || !data[0]) return 0;
                this.manualBalanceDate = data[0].updated_at; // Carrega a data da Ãºltima ediÃ§Ã£o
                return parseFloat(data[0].amount);
            }

            async saveBalanceToSupabase(amount) {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return false;
                const updatedAt = new Date().toISOString();
                const { error } = await supabase
                    .from('balances')
                    .upsert([{ user_id: user.id, amount, updated_at: updatedAt }], { onConflict: ['user_id'] });
                if (error) {
                    this.showNotification('Erro ao salvar saldo', 'error');
                    return false;
                }
                this.manualBalance = amount;
                this.manualBalanceDate = updatedAt; // Salva a data da ediÃ§Ã£o
                return true;
            }

            async fetchBudgetsFromSupabase() {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return [];
                const { data, error } = await supabase
                    .from('budgets')
                    .select('id,category,budget_limit,period,createdAt,user_id')
                    .eq('user_id', user.id) // <-- filtra pelo usuÃ¡rio logado
                    .order('createdAt', { ascending: false });
                if (error) {
                    this.showNotification('Erro ao carregar orÃ§amentos do servidor', 'error');
                    return [];
                }
                return (data || []).map(b => ({
                    ...b,
                    limit: b.budget_limit
                }));
            }
            async fetchGoalsFromSupabase() {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return [];
                const { data, error } = await supabase
                    .from('goals')
                    .select('id,name,icon,target,current,deadline,createdAt,user_id')
                    .eq('user_id', user.id) // <-- filtra pelo usuÃ¡rio logado
                    .order('createdAt', { ascending: false });
                if (error) {
                    this.showNotification('Erro ao carregar metas do servidor', 'error');
                    return [];
                }
                return data || [];
            }

            async addTransactionToSupabase(transaction) {
                // Pega o usuÃ¡rio autenticado
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) {
                    this.showNotification('UsuÃ¡rio nÃ£o autenticado', 'error');
                    return false;
                }
                const { id,createdAt, updatedAt, ...txData } = transaction;
                txData.user_id = user.id; // Adiciona o user_id
                const { data, error } = await supabase.from('transactions').insert([txData]).select();
                if (error) {
                    console.log('Supabase insert error:', error);
                    this.showNotification('Erro ao salvar transaÃ§Ã£o no servidor', 'error');
                    return false;
                }
                return { data };
            }

            async updateTransactionInSupabase(transaction) {
                const { id, createdAt, updatedAt, ...txData } = transaction;
                const { error } = await supabase.from('transactions').update(txData).eq('id', id);
                if (error) {
                    this.showNotification('Erro ao atualizar transaÃ§Ã£o no servidor', 'error');
                    return false;
                }
                return true;
            }

            async deleteTransactionFromSupabase(id) {
                const { error } = await supabase.from('transactions').delete().eq('id', id);
                if (error) {
                    this.showNotification('Erro ao excluir transaÃ§Ã£o no servidor', 'error');
                    return false;
                }
                return true;
            }

            async addGoalToSupabase(goal) {
                const { id, createdAt, ...goalData } = goal;
                const { data, error } = await supabase.from('goals').insert([goalData]).select();
                if (error) {
                    this.showNotification('Erro ao salvar meta no servidor', 'error');
                    return false;
                }
                return { data };
            }

            async updateGoalInSupabase(goal) {
                const { id, ...goalData } = goal;
                const { error } = await supabase.from('goals').update(goalData).eq('id', id);
                if (error) {
                    this.showNotification('Erro ao atualizar meta no servidor', 'error');
                    return false;
                }
                return true;
            }

            async deleteGoalFromSupabase(id) {
                const { error } = await supabase.from('goals').delete().eq('id', id);
                if (error) {
                    this.showNotification('Erro ao excluir meta no servidor', 'error');
                    return false;
                }
                return true;
            }
            
            // ...dentro da classe FinanceApp...
            async init() {
                this.setupEventListeners();
                this.initializeTheme();
                // Carrega categorias antes de qualquer renderizaÃ§Ã£o
                this.categories = await this.fetchCategoriesFromSupabase();
                this.manualBalance = await this.fetchBalanceFromSupabase();
                this.renderCurrentSection();
                this.startAutoSave();
                this.setupSidebarProfile();
            }

            async fetchCategoriesFromSupabase() {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return [];
                const { data, error } = await supabase
                    .from('categories')
                    .select('id,name,icon,description,user_id')
                    .eq('user_id', user.id)
                    .order('created_at', { ascending: false });
                // Adiciona o campo fixed sÃ³ no JS
                const fixedNames = ['SalÃ¡rio', 'Lazer', 'Casa'];
                return (data || []).map(cat => ({
                    ...cat,
                    fixed: fixedNames.includes(cat.name)
                }));
            }

            async addCategoryToSupabase(category) {
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) return false;

                // Remove o campo fixed antes de enviar
                const { fixed, ...categoryData } = category;

                // Verifica se jÃ¡ existe categoria com mesmo nome para o usuÃ¡rio
                const { data: existing, error: fetchError } = await supabase
                    .from('categories')
                    .select('id')
                    .eq('user_id', user.id)
                    .eq('name', category.name)
                    .maybeSingle();

                if (existing && existing.id) {
                    this.showNotification('JÃ¡ existe uma categoria com esse nome.', 'error');
                    return false;
                }

                const { data, error } = await supabase
                    .from('categories')
                    .insert([{ ...categoryData, user_id: user.id }])
                    .select();
                if (error) {
                    this.showNotification('Erro ao criar categoria.', 'error');
                    return false;
                }
                return data[0];
            }

            categories = [];

            async updateCategoryInSupabase(category) {
                const { id, ...catData } = category;
                const { error } = await supabase
                    .from('categories')
                    .update(catData)
                    .eq('id', id);
                return !error;
            }

            async deleteCategoryFromSupabase(id) {
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);
                return !error;
            }

            async renderCategories() {
                // Categorias fixas
                const fixedCategories = [
                    { name: 'SalÃ¡rio', icon: 'ðŸ’¼', description: 'Recebimentos', fixed: true },
                    { name: 'Lazer', icon: 'ðŸŽ‰', description: 'DiversÃ£o e lazer', fixed: true },
                    { name: 'Casa', icon: 'ðŸ ', description: 'Despesas com moradia', fixed: true }
                ];

                let categories = await this.fetchCategoriesFromSupabase();

                // Garante que as fixas existem e marca como fixed
                for (const fixed of fixedCategories) {
                    let found = categories.find(cat => cat.name === fixed.name);
                    if (!found) {
                        await this.addCategoryToSupabase({ ...fixed });
                        categories = await this.fetchCategoriesFromSupabase();
                        found = categories.find(cat => cat.name === fixed.name);
                    }
                    if (found) found.fixed = true;
                }

                // Marca as fixas
                categories = categories.map(cat => {
                    if (fixedCategories.some(f => f.name === cat.name)) {
                        return { ...cat, fixed: true };
                    }
                    return cat;
                });

                this.categories = categories;

                const grid = document.getElementById('categoriesGrid');
                if (!grid) return;

                // Card de adicionar categoria
                const addCard = `
                    <div onclick="app.openCategoryModal()" class="cursor-pointer bg-white dark:bg-gray-800 border-2 border-dashed border-primary-600 flex flex-col items-center justify-center rounded-xl h-40 transition hover:bg-primary-50 dark:hover:bg-primary-900 hover:border-primary-700">
                        <div class="text-4xl text-primary-600 mb-2">ï¼‹</div>
                        <div class="text-sm font-medium text-primary-700 dark:text-primary-300">Nova Categoria</div>
                    </div>
                    `;

                    // Cards das categorias
                    const catCards = categories.map(cat => `
                    <div class="group bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 flex flex-col items-center justify-center h-40 transition-all duration-300 relative">
                        <div class="text-4xl mb-2">${cat.icon || 'ðŸ“¦'}</div>
                        <div class="font-semibold text-gray-900 dark:text-gray-100 mb-1">${cat.name}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-2 text-center">${cat.description || ''}</div>
                        ${cat.fixed ? '' : `
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2">
                            <button onclick="event.stopPropagation();app.openEditCategoryModal(${cat.id})" class="p-1 rounded hover:bg-blue-100 dark:hover:bg-blue-900 transition"><svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536M9 11l6 6M3 21h6v-6l9-9a2.828 2.828 0 10-4-4l-9 9z"></path></svg></button>
                            <button onclick="event.stopPropagation();app.deleteCategory(${cat.id})" class="p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition"><svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        </div>
                        `}
                    </div>
                    `).join('');

                    grid.innerHTML = addCard + catCards;
                }

            async openCategoryModal(category = null) {
                const isEdit = !!category;
                const modalId = 'categoryModal';
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

                // Ãcones agrupados por categoria visual
                const iconGroups = [
                    {
                        title: 'Dinheiro',
                        icons: ['ðŸ’¼','ðŸ’°','ðŸ“ˆ','ðŸ›’','ðŸ¦','ðŸ§']
                    },
                    {
                        title: 'Casa',
                        icons: ['ðŸ ','ðŸ¡','ðŸ˜ï¸','ðŸ›ï¸','ðŸ§º','ðŸ§¹','ðŸšª']
                    },
                    {
                        title: 'Comida',
                        icons: ['ðŸ”','ðŸ•','ðŸŸ','ðŸ—','ðŸ³','ðŸ©','ðŸ«','ðŸŽ','ðŸº','ðŸ·','ðŸ§ƒ','ðŸ§','ðŸ«','ðŸ©','ðŸŸ','ðŸ—','ðŸ–','ðŸ³','ðŸ¥—','ðŸ¥ª','ðŸ¥¤']
                    },
                    {
                        title: 'Transporte',
                        icons: ['ðŸš—','ðŸšŒ','ðŸš•','ðŸš™','ðŸšš','ðŸš’','ðŸš‘','ðŸš“','ðŸšœ','ðŸš','âœˆï¸','ðŸ›³ï¸','â›µ','ðŸš²']
                    },
                    {
                        title: 'Lazer',
                        icons: ['ðŸŽ‰','ðŸŽ®','ðŸŽ“','ðŸ§¸','ðŸŸï¸','ðŸ›ï¸','ðŸ°','ðŸ¯','ðŸ’’','ðŸ—¼','ðŸ—½']
                    },
                    {
                        title: 'SaÃºde',
                        icons: ['ðŸ¥','ðŸ’¡','ðŸ§´']
                    },
                    {
                        title: 'EducaÃ§Ã£o',
                        icons: ['ðŸ“š','ðŸ§¾']
                    },
                    {
                        title: 'Outros',
                        icons: ['ðŸ’»','ðŸ“±','ðŸ› ï¸','ðŸ§Š','ðŸ§‚','ðŸ­','ðŸ¢','ðŸ£','ðŸ¤','ðŸ¬','â›ª','ðŸ•Œ','ðŸ•','â›©ï¸','ðŸ•‹']
                    }
                ];
                const selectedIcon = category?.icon || '';

                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-sm w-full mx-4 p-6 animate-bounce-in">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">${isEdit ? 'Editar' : 'Nova'} Categoria</h3>
                        <form id="categoryForm" class="space-y-4">
                            <input type="text" name="name" required maxlength="30" placeholder="Nome" 
                                class="w-full px-3 py-2 border rounded text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700" 
                                value="${category?.name || ''}" />
                            <input type="hidden" name="icon" value="${selectedIcon}">
                            <div class="mb-2">
                                <input type="text" id="iconSearch" placeholder="Buscar Ã­cone..." 
                                    class="w-full px-3 py-2 border rounded mb-3 text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700" />
                            </div>
                            <div id="iconCatalog" class="space-y-4 max-h-48 overflow-y-auto pr-2">
                                ${iconGroups.map(group => `
                                    <div>
                                        <div class="font-semibold text-xs mb-1 text-gray-700 dark:text-gray-200">${group.title}</div>
                                        <div class="flex flex-wrap gap-2">
                                            ${group.icons.map(icon => `
                                                <button type="button" class="icon-btn text-2xl rounded-full border-2 transition
                                                    ${selectedIcon === icon ? 'border-primary-600 bg-primary-50 dark:bg-primary-900' : 'border-transparent'}
                                                    text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700"
                                                ">${icon}</button>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <input type="text" name="description" maxlength="100" placeholder="DescriÃ§Ã£o" 
                                class="w-full px-3 py-2 border rounded text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700" 
                                value="${category?.description || ''}" />
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" 
                                    class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-gray-100 bg-white dark:bg-gray-700 border rounded hover:bg-gray-50 dark:hover:bg-gray-600">
                                    Cancelar
                                </button>
                                <button type="submit" 
                                    class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded hover:bg-primary-700">
                                    Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modalsContainer').appendChild(modal);

                // SeleÃ§Ã£o visual do Ã­cone e busca
                setTimeout(() => {
                    const iconBtns = modal.querySelectorAll('.icon-btn');
                    iconBtns.forEach(btn => {
                        btn.onclick = () => {
                            modal.querySelector('input[name="icon"]').value = btn.textContent;
                            iconBtns.forEach(b => b.classList.remove('border-primary-600', 'bg-primary-50', 'dark:bg-primary-900'));
                            btn.classList.add('border-primary-600', 'bg-primary-50', 'dark:bg-primary-900');
                        };
                    });
                    // Seleciona visualmente o Ã­cone jÃ¡ salvo
                    if (selectedIcon) {
                        iconBtns.forEach(btn => {
                            if (btn.textContent === selectedIcon) {
                                btn.classList.add('border-primary-600', 'bg-primary-50', 'dark:bg-primary-900');
                            }
                        });
                    }

                    // Busca de Ã­cone
                    const searchInput = modal.querySelector('#iconSearch');
                    searchInput.addEventListener('input', () => {
                        const term = searchInput.value.trim().toLowerCase();
                        modal.querySelectorAll('#iconCatalog > div').forEach(groupDiv => {
                            const groupTitle = groupDiv.querySelector('div.font-semibold')?.textContent.toLowerCase() || '';
                            let groupHasMatch = false;
                            groupDiv.querySelectorAll('.icon-btn').forEach(btn => {
                                const icon = btn.textContent;
                                const match = icon.includes(term) || groupTitle.includes(term);
                                btn.style.display = match ? '' : 'none';
                                if (match) groupHasMatch = true;
                            });
                            groupDiv.style.display = groupHasMatch ? '' : 'none';
                        });
                    });
                }, 100);

                modal.querySelector('#categoryForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const name = form.name.value.trim();
                    const icon = form.icon.value.trim() || 'ðŸ“¦';
                    const description = form.description.value.trim();
                    if (!name) return;
                    if (isEdit) {
                        const updated = { ...category, name, icon, description };
                        await this.updateCategoryInSupabase(updated);
                    } else {
                        await this.addCategoryToSupabase({ name, icon, description });
                    }
                    this.closeModal(modalId);
                    this.renderCategories();
                    this.renderCurrentSection();
                };
            }
            openEditCategoryModal(id) {
                const cat = this.categories.find(c => c.id === id);
                if (cat) this.openCategoryModal(cat);
            }

            // Bloqueia ediÃ§Ã£o/exclusÃ£o das fixas
            async deleteCategory(id) {
                const cat = this.categories.find(c => c.id === id);
                if (cat?.fixed) {
                    this.showNotification('Esta categoria nÃ£o pode ser excluÃ­da.', 'error');
                    return;
                }
                // Verifica se hÃ¡ transaÃ§Ãµes usando a categoria
                const usedInTransactions = this.transactions.some(t => t.category == id);
                if (usedInTransactions) {
                    // Mostra modal de migraÃ§Ã£o
                    this.openCategoryMigrationModal(id);
                    return;
                }
                if (confirm('Deseja excluir esta categoria?')) {
                    await this.deleteCategoryFromSupabase(id);
                    this.renderCategories();
                }
            }

            // Modal para migraÃ§Ã£o de transaÃ§Ãµes
            openCategoryMigrationModal(categoryId) {
                const modalId = 'categoryMigrationModal';
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

                // Lista de categorias para migrar (exceto a atual e fixas)
                const otherCategories = this.categories.filter(c => c.id !== categoryId);

                modal.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-sm w-full mx-4 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">Migrar TransaÃ§Ãµes</h3>
                        <p class="mb-4 text-gray-700 dark:text-gray-300">
                            NÃ£o Ã© possÃ­vel excluir esta categoria pois ela estÃ¡ sendo utilizada em transaÃ§Ãµes.<br>
                            Para excluir, migre todas as transaÃ§Ãµes para outra categoria.
                        </p>
                        <form id="categoryMigrationForm" class="space-y-4">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nova Categoria</label>
                            <select name="newCategory" required class="w-full px-3 py-2 border rounded">
                                <option value="">Selecione a categoria</option>
                                ${otherCategories.map(cat => `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`).join('')}
                            </select>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border rounded hover:bg-gray-50 dark:hover:bg-gray-600">Cancelar</button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 rounded hover:bg-primary-700">Migrar e Excluir</button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modalsContainer').appendChild(modal);

                modal.querySelector('#categoryMigrationForm').onsubmit = async (e) => {
                    e.preventDefault();
                    const newCategoryId = e.target.newCategory.value;
                    if (!newCategoryId) return;
                    // Atualiza todas as transaÃ§Ãµes para nova categoria
                    await this.migrateTransactionsCategory(categoryId, newCategoryId);
                    // Exclui categoria antiga
                    await this.deleteCategoryFromSupabase(categoryId);
                    this.closeModal(modalId);
                    this.renderCategories();
                    this.renderCurrentSection();
                    this.showNotification('TransaÃ§Ãµes migradas e categoria excluÃ­da!', 'success');
                };
            }

            // FunÃ§Ã£o para migrar transaÃ§Ãµes de uma categoria para outra
            async migrateTransactionsCategory(oldCategoryId, newCategoryId) {
                // Atualiza no Supabase
                const { error } = await supabase
                    .from('transactions')
                    .update({ category: newCategoryId })
                    .eq('category', oldCategoryId);
                if (error) {
                    this.showNotification('Erro ao migrar transaÃ§Ãµes.', 'error');
                    return false;
                }
                // Atualiza localmente
                this.transactions = await this.fetchTransactionsFromSupabase();
                return true;
            }

                openEditCategoryModal(id) {
                    const cat = this.categories.find(c => c.id === id);
                    if (cat?.fixed) {
                        this.showNotification('Esta categoria nÃ£o pode ser editada.', 'error');
                        return;
                    }
                    if (cat) this.openCategoryModal(cat);
                }
            
            // Theme Management
            initializeTheme() {
                const theme = localStorage.getItem('theme') || 'auto';
                this.applyTheme(theme);
                this.setupThemeListeners();
            }
            
            setupThemeListeners() {
                // Listen for system theme changes
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', (e) => {
                    if (this.currentTheme === 'auto') {
                        this.applyTheme('auto');
                    }
                });
            }
            
            applyTheme(theme) {
                const html = document.documentElement;
                
                // Remove all theme classes first
                html.classList.remove('dark', 'light');
                
                if (theme === 'auto') {
                    // Use system preference
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    if (prefersDark) {
                        html.classList.add('dark');
                    }
                } else if (theme === 'dark') {
                    html.classList.add('dark');
                } else if (theme === 'light') {
                    html.classList.add('light');
                }
                
                this.currentTheme = theme;
                localStorage.setItem('theme', theme);
                this.updateThemeToggle();
                
                // Animate theme icon
                const themeIcon = document.getElementById('themeIcon');
                if (themeIcon) {
                    themeIcon.classList.add('rotate');
                    setTimeout(() => {
                        themeIcon.classList.remove('rotate');
                    }, 300);
                }
            }
            
            updateThemeToggle() {
                const themeIcon = document.getElementById('themeIcon');
                const themeText = document.getElementById('themeText');
                const themeMode = document.getElementById('themeMode');
                const isDark = document.documentElement.classList.contains('dark');
                
                // Update icon and text based on current appearance
                if (isDark) {
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>';
                    
                } else {
                    themeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
                    
                }
                
                // Update mode indicator
                const modeTexts = {
                    'auto': 'Auto',
                    'light': 'Manual - Claro',
                    'dark': 'Manual - Escuro'
                };
                
                if (themeMode) {
                    themeMode.textContent = modeTexts[this.currentTheme] || 'Auto';
                }
                
                // Update settings theme selector
                const themeSelect = document.getElementById('themeSelect');
                if (themeSelect) {
                    themeSelect.value = this.currentTheme;
                }
            }

            updateTransactions(newTransactions) {
            this.transactions = newTransactions;
            
            if (this.currentSection === 'dashboard') {
                this.renderDashboard();
            } else if (this.currentSection === 'transactions') {
                this.renderTransactions();
            }
        }

            
            // Translation function
            t(key) {
                const translations = {
                };
                return translations[this.currentLanguage]?.[key] || key;
            }
            
            // Event Listeners Setup
            setupEventListeners() {
                // Navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => this.handleNavigation(e));
                });
                
                // Mobile menu
                document.getElementById('menuToggle').addEventListener('click', () => this.toggleSidebar());
                document.getElementById('closeSidebar').addEventListener('click', () => this.toggleSidebar());
                document.getElementById('sidebarOverlay').addEventListener('click', () => this.toggleSidebar());
                
                // Theme toggle
                document.getElementById('themeToggle').addEventListener('click', this.toggleTheme.bind(this));
                
                // Settings theme selector
                document.addEventListener('change', (e) => {
                    if (e.target.id === 'themeSelect') {
                        this.applyTheme(e.target.value);
                    }
                });
                
                // Add buttons
                document.getElementById('addTransactionBtn').addEventListener('click', () => {
                    this.openTransactionModal();
                });
                
                document.getElementById('addTransactionFab').addEventListener('click', () => {
                    this.openTransactionModal();
                });

                
                // Window resize
                window.addEventListener('resize', () => this.handleResize());

                const addCategoryBtn = document.getElementById('addCategoryBtn');
                if (addCategoryBtn) {
                    addCategoryBtn.addEventListener('click', () => this.openCategoryModal());
                }
            }
            
            // Navigation
            handleNavigation(e) {
                e.preventDefault();
                const section = e.currentTarget.dataset.section;
                this.navigateToSection(section);
            }
            
            navigateToSection(section) {
                // Update active nav link
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                
                const activeLink = document.querySelector(`[data-section="${section}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                }
                
                // Hide all sections
                document.querySelectorAll('section').forEach(sec => sec.classList.add('hidden'));
                
                // Show target section
                const targetSection = document.getElementById(`${section}-section`);
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('animate-fade-in');
                }
                
                // Update page title
                const titles = {
                    dashboard: this.t('Dashboard'),
                    transactions: this.t('TransaÃ§Ãµes'),
                    budgets: this.t('OrÃ§amentos'),
                    goals: this.t('Metas'),
                    reports: this.t('RelatÃ³rios'),
                    settings: this.t('ConfiguraÃ§Ãµes')
                };
          
                document.getElementById('pageTitle').textContent = titles[section];
                this.currentSection = section;
                
                // Render section content
                this.renderCurrentSection();
                
                // Close sidebar on mobile
                if (window.innerWidth < 1024) {
                    this.closeSidebar();
                }
            }
            
            // Sidebar Management
            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            }
            
            closeSidebar() {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
            
            // Theme Toggle
            toggleTheme() {
                const currentTheme = this.currentTheme;
                let newTheme;
                
                // Cycle through: auto -> light -> dark -> auto
                if (currentTheme === 'auto') {
                    const isDark = document.documentElement.classList.contains('dark');
                    newTheme = isDark ? 'light' : 'dark';
                } else if (currentTheme === 'light') {
                    newTheme = 'dark';
                } else {
                    newTheme = 'auto';
                }
                
                this.applyTheme(newTheme);
                
            }
            
            // Data Validation
            validateData(data, rules) {
                const errors = {};
                
                for (const [field, rule] of Object.entries(rules)) {
                    const value = data[field];
                    
                    // Required validation
                    if (rule.required && (!value || value === '')) {
                        errors[field] = `${field} is required`;
                        continue;
                    }
                    
                    // Skip other validations if field is empty and not required
                    if (!value && !rule.required) continue;
                    
                    // Type validations
                    if (rule.min !== undefined && parseFloat(value) < rule.min) {
                        errors[field] = `${field} must be at least ${rule.min}`;
                    }
                    
                    if (rule.max !== undefined && parseFloat(value) > rule.max) {
                        errors[field] = `${field} must be at most ${rule.max}`;
                    }
                    
                    if (rule.minLength !== undefined && value.length < rule.minLength) {
                        errors[field] = `${field} must be at least ${rule.minLength} characters`;
                    }
                    
                    if (rule.maxLength !== undefined && value.length > rule.maxLength) {
                        errors[field] = `${field} must be at most ${rule.maxLength} characters`;
                    }
                    
                    if (rule.enum && !rule.enum.includes(value)) {
                        errors[field] = `${field} must be one of: ${rule.enum.join(', ')}`;
                    }
                }
                
                return {
                    isValid: Object.keys(errors).length === 0,
                    errors
                };
            }
            
            // Data Sanitization
            sanitizeInput(input) {
                if (typeof input !== 'string') return input;
                
                return input
                    .replace(/[<>]/g, '') // Remove potential HTML tags
                    .trim() // Remove whitespace
                    .substring(0, 1000); // Limit length
            }
            
            sanitizeData(data) {
                const sanitized = {};
                for (const [key, value] of Object.entries(data)) {
                    sanitized[key] = this.sanitizeInput(value);
                }
                return sanitized;
            }
            
            // Budget Calculations
            calculateBudgetSpent(categoryId) {
                const budget = this.budgets.find(b => b.category === categoryId);
                if (!budget) return 0;

                const now = new Date();
                return this.transactions.filter(t => {
                    if (t.type !== 'expense' || t.category !== categoryId) return false;
                    const date = new Date(t.date);

                    if (budget.period === 'monthly') {
                        return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
                    }
                    if (budget.period === 'weekly') {
                        // Semana ISO (segunda a domingo)
                        const getWeek = d => {
                            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
                            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
                            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
                        };
                        return getWeek(date) === getWeek(now) && date.getFullYear() === now.getFullYear();
                    }
                    if (budget.period === 'yearly') {
                        return date.getFullYear() === now.getFullYear();
                    }
                    return false;
                }).reduce((sum, t) => sum + t.amount, 0);
            }
            
            // Modal Management
            async openTransactionModal(transaction = null) {
                // Aguarda garantir que as categorias estÃ£o carregadas (inclusive as padrÃ£o)
                if (!this.categories || this.categories.length === 0) {
                    await this.renderCategories();
                    // Atualiza this.categories apÃ³s renderCategories
                    this.categories = await this.fetchCategoriesFromSupabase();
                }
                const modal = this.createTransactionModal(transaction);
                document.getElementById('modalsContainer').appendChild(modal);

                // Show modal with animation
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }

            openBudgetModal() {
                const modal = this.createBudgetModal();
                const container = document.getElementById('modalsContainer');
                container.appendChild(modal);

                // Show modal com animaÃ§Ã£o
                setTimeout(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                }, 10);
            }




            createBudgetModal() {
                const modalId = 'budgetModal';
                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';

                modal.innerHTML = `
                    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">Novo OrÃ§amento</h3>
                        </div>
                        <form id="budgetForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                                <select name="category" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <option value="">Selecione a categoria</option>
                                    ${this.categories.map(cat =>
                                        `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor do Limite</label>
                                <input type="number" name="limit" min="0" step="0.01" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="0,00" />
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    Criar
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                // Aqui pega o form dentro do modal e adiciona o evento submit
                const form = modal.querySelector('#budgetForm');
                // ...dentro do eventListener do form em createBudgetModal...

                form.addEventListener('submit', async e => {
                    e.preventDefault();
                    const category = form.category.value;
                    const limit = parseFloat(form.limit.value);

                    if (!category) {
                        alert('Por favor, selecione uma categoria.');
                        return;
                    }
                    if (isNaN(limit) || limit <= 0) {
                        alert('Por favor, insira um valor vÃ¡lido para o limite.');
                        return;
                    }

                    const user = supabase.auth.getUser ? (await supabase.auth.getUser()).data.user : null;
                    const newBudget = {
                        category: category,
                        budget_limit: limit,
                        period: 'monthly',
                        user_id: user ? user.id : null
                    };
                    const ok = await this.addBudgetToSupabase(newBudget);
                    if (ok && ok.data && ok.data[0]) {
                        const budgetFromDb = ok.data[0];
                        this.budgets.push({
                            ...budgetFromDb,
                            limit: budgetFromDb.budget_limit
                        });
                        this.renderBudgets();
                        this.closeModal(modalId);
                    }
                });

                return modal;
            }

            createTransactionModal(transaction = null) {
                const isEdit = !!transaction;
                const modalId = 'transactionModal';

                const selectedType = transaction?.type || 'income';

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';

                modal.innerHTML = `
                    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                                ${isEdit ? 'Editar TransaÃ§Ã£o' : 'Nova TransaÃ§Ã£o'}
                            </h3>
                        </div>
                        <form id="transactionForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                                <div class="flex gap-4 mb-2">
                                    <button type="button" id="btnIncome" class="flex-1 px-4 py-3 rounded-lg border-2 font-semibold text-green-700 dark:text-green-400 bg-green-50 dark:bg-green-900 transition-all duration-200
                                        ${selectedType === 'income' ? 'border-green-600 ring-2 ring-green-400' : 'border-gray-300 dark:border-gray-600'}">
                                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                        </svg>
                                        Receita
                                    </button>
                                    <button type="button" id="btnExpense" class="flex-1 px-4 py-3 rounded-lg border-2 font-semibold text-red-700 dark:text-red-400 bg-red-50 dark:bg-red-900 transition-all duration-200
                                        ${selectedType === 'expense' ? 'border-red-600 ring-2 ring-red-400' : 'border-gray-300 dark:border-gray-600'}">
                                        <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                        </svg>
                                        Despesa
                                    </button>
                                </div>
                                <input type="hidden" name="type" value="${selectedType}">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <!-- ...restante do formulÃ¡rio igual... -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor</label>
                                <input type="number" name="amount" step="0.01" min="0.01" max="999999.99" value="${transaction?.amount || ''}" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="0,00">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Categoria</label>
                                <select name="category" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <option value="">Selecione a categoria</option>
                                    ${this.categories.map(cat => 
                                        `<option value="${cat.id}" ${transaction?.category == cat.id ? 'selected' : ''}>${cat.icon || 'ðŸ“¦'} ${cat.name}</option>`
                                    ).join('')}
                                    <option value="__new__">ï¼‹ Nova Categoria</option>
                                </select>
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
                                <input type="date" name="date" value="${transaction?.date || new Date().toISOString().split('T')[0]}" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">DescriÃ§Ã£o</label>
                                <input type="text" name="description" value="${transaction?.description || ''}" required maxlength="100" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent" placeholder="DescriÃ§Ã£o da transaÃ§Ã£o">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>
                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    ${isEdit ? 'Atualizar' : 'Salvar'}
                                </button>
                            </div>
                        </form>
                    </div>
                `;

                setTimeout(() => {
                    // BotÃµes de tipo
                    const btnIncome = modal.querySelector('#btnIncome');
                    const btnExpense = modal.querySelector('#btnExpense');
                    const typeInput = modal.querySelector('input[name="type"]');

                    btnIncome.onclick = () => {
                        btnIncome.classList.add('border-green-600', 'ring-2', 'ring-green-400');
                        btnExpense.classList.remove('border-red-600', 'ring-2', 'ring-red-400');
                        btnIncome.classList.remove('border-gray-300', 'dark:border-gray-600');
                        btnExpense.classList.add('border-gray-300', 'dark:border-gray-600');
                        typeInput.value = 'income';
                    };
                    btnExpense.onclick = () => {
                        btnExpense.classList.add('border-red-600', 'ring-2', 'ring-red-400');
                        btnIncome.classList.remove('border-green-600', 'ring-2', 'ring-green-400');
                        btnExpense.classList.remove('border-gray-300', 'dark:border-gray-600');
                        btnIncome.classList.add('border-gray-300', 'dark:border-gray-600');
                        typeInput.value = 'expense';
                    };

                    // Categoria: Nova categoria
                    const categorySelect = modal.querySelector('select[name="category"]');
                    if (categorySelect) {
                        categorySelect.addEventListener('change', async (e) => {
                            if (e.target.value === '__new__') {
                                this.closeModal('transactionModal');
                                await new Promise(resolve => {
                                    this.openCategoryModal();
                                    const observer = new MutationObserver(() => {
                                        if (!document.getElementById('categoryModal')) {
                                            observer.disconnect();
                                            resolve();
                                        }
                                    });
                                    observer.observe(document.body, { childList: true, subtree: true });
                                });
                                this.categories = await this.fetchCategoriesFromSupabase();
                                this.openTransactionModal(transaction);
                            }
                        });
                    }
                }, 100);

                modal.querySelector('#transactionForm').addEventListener('submit', (e) => {
                    this.handleTransactionSubmit(e, transaction);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeModal(modalId);
                    }
                });

                return modal;
            }

            async handleTransactionSubmit(e, existingTransaction = null) {
                e.preventDefault();

                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());

                // Sanitize data
                const sanitizedData = this.sanitizeData(data);

                // Validate data
                const validation = this.validateData(sanitizedData, this.validationRules.transaction);

                if (!validation.isValid) {
                    this.displayFormErrors(e.target, validation.errors);
                    return;
                }

                // Clear any existing errors
                this.clearFormErrors(e.target);

                // Prepare transaction object
                const transaction = {
                    id: existingTransaction?.id || Date.now(),
                    type: sanitizedData.type,
                    amount: parseFloat(sanitizedData.amount),
                    category: sanitizedData.category,
                    date: sanitizedData.date,
                    description: sanitizedData.description,
                    createdAt: existingTransaction?.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                let ok;
                if (existingTransaction) {
                    // Atualizar no Supabase
                    ok = await this.updateTransactionInSupabase(transaction);
                } else {
                    // Adicionar no Supabase
                    ok = await this.addTransactionToSupabase(transaction);
                }

                // Sempre recarregue as transaÃ§Ãµes do Supabase para garantir dados atualizados
                this.transactions = await this.fetchTransactionsFromSupabase();

                // Update UI
                this.renderCurrentSection();

                // Close modal
                this.closeModal('transactionModal');

                // Show success notification
                this.showNotification(
                    existingTransaction ? 'TransaÃ§Ã£o atualizada com sucesso!' : 'TransaÃ§Ã£o adicionada com sucesso!',
                    'success'
                );
            }
            
            displayFormErrors(form, errors) {
                // Clear existing errors
                this.clearFormErrors(form);
                
                // Display new errors
                for (const [field, message] of Object.entries(errors)) {
                    const input = form.querySelector(`[name="${field}"]`);
                    const errorDiv = input?.parentNode.querySelector('.error-message');
                    
                    if (input && errorDiv) {
                        input.classList.add('border-red-500', 'focus:ring-red-500');
                        errorDiv.textContent = message;
                        errorDiv.classList.remove('hidden');
                    }
                }
            }
            
            clearFormErrors(form) {
                form.querySelectorAll('.error-message').forEach(error => {
                    error.classList.add('hidden');
                    error.textContent = '';
                });
                
                form.querySelectorAll('input, select').forEach(input => {
                    input.classList.remove('border-red-500', 'focus:ring-red-500');
                });
            }
            
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.remove();
                this.currentGoalIdToAdd = null;
            }

            async setupSidebarProfile() {
                const user = (await supabase.auth.getUser()).data.user;
                const name = user?.user_metadata?.full_name || user?.user_metadata?.name || user?.email || 'UsuÃ¡rio';
                const avatarUrl = user?.user_metadata?.avatar_url;
                const initials = name.split(' ').map(n => n[0]).join('').slice(0,2).toUpperCase();

                // Avatar
                const avatarDiv = document.getElementById('sidebarProfileAvatar');
                if (avatarDiv) {
                    if (avatarUrl) {
                        avatarDiv.innerHTML = `<img src="${avatarUrl}" alt="Avatar" class="w-10 h-10 rounded-full object-cover">`;
                    } else {
                        avatarDiv.textContent = initials;
                    }
                }
                // Nome
                const nameDiv = document.getElementById('sidebarProfileName');
                if (nameDiv) nameDiv.textContent = name;

                // Dropdown toggle
                const btn = document.getElementById('sidebarProfileBtn');
                const dropdown = document.getElementById('sidebarProfileDropdown');
                if (btn && dropdown) {
                    btn.onclick = (e) => {
                        e.stopPropagation();
                        dropdown.classList.toggle('hidden');
                    };
                    // Fecha dropdown ao clicar fora
                    document.addEventListener('click', () => dropdown.classList.add('hidden'));
                }

                // ConfiguraÃ§Ãµes
                document.getElementById('profileSettingsBtn')?.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdown.classList.add('hidden');
                    this.navigateToSection('settings');
                });

                // Logout
                document.getElementById('profileLogoutBtn')?.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    dropdown.classList.add('hidden');
                    await supabase.auth.signOut();
                    window.location.reload();
                });
            }

            
            // Notification System
            showNotification(message, type = 'success', duration = 3000) {
                const notification = document.createElement('div');
                notification.className = `notification bg-white dark:bg-gray-800 border-l-4 ${this.getNotificationColor(type)} rounded-lg shadow-lg p-4 mb-2 transform translate-x-full transition-transform duration-300`;
                
                notification.innerHTML = `
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            ${this.getNotificationIcon(type)}
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900 dark:text-gray-100">${message}</p>
                        </div>
                        <div class="ml-auto pl-3">
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('notificationContainer').appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 10);
                
                // Auto remove
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, duration);
            }
            
            getNotificationColor(type) {
                const colors = {
                    success: 'border-green-500',
                    error: 'border-red-500',
                    warning: 'border-yellow-500',
                    info: 'border-blue-500'
                };
                return colors[type] || colors.info;
            }
            
            getNotificationIcon(type) {
                const icons = {
                    success: '<svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    error: '<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                    warning: '<svg class="w-5 h-5 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>',
                    info: '<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
                };
                return icons[type] || icons.info;
            }

            updateSyncStatus(status) {
                // Implemente se quiser mostrar status de sincronizaÃ§Ã£o
                // Exemplo:
                // const el = document.getElementById('syncStatus');
                // if (el) el.textContent = status;
            }
            
            startAutoSave() {
                // Auto-save every 30 seconds
                setInterval(() => {
                }, 30000);
            }
            
            // Utility Functions
            formatCurrency(amount) {
                const currencies = {
                    'BRL': { locale: 'pt-BR', currency: 'BRL' },
                    'USD': { locale: 'en-US', currency: 'USD' },
                    'EUR': { locale: 'de-DE', currency: 'EUR' }
                };
                
                const defaultCurrency = localStorage.getItem('defaultCurrency') || 'BRL';
                const config = currencies[defaultCurrency];
                
                return new Intl.NumberFormat(config.locale, {
                    style: 'currency',
                    currency: config.currency
                }).format(amount);
            }
            
            getCategoryName(categoryKey) {
                const names = {
                    'pt-BR': {
                        food: 'AlimentaÃ§Ã£o',
                        transport: 'Transporte',
                        health: 'SaÃºde',
                        entertainment: 'Lazer',
                        education: 'EducaÃ§Ã£o',
                        home: 'Casa',
                        salary: 'SalÃ¡rio',
                        freelance: 'Freelance',
                        investment: 'Investimentos',
                        other: 'Outros'
                    },
                    'en-US': {
                        food: 'Food',
                        transport: 'Transport',
                        health: 'Health',
                        entertainment: 'Entertainment',
                        education: 'Education',
                        home: 'Home',
                        salary: 'Salary',
                        freelance: 'Freelance',
                        investment: 'Investment',
                        other: 'Other'
                    },
                    'es-ES': {
                        food: 'AlimentaciÃ³n',
                        transport: 'Transporte',
                        health: 'Salud',
                        entertainment: 'Entretenimiento',
                        education: 'EducaciÃ³n',
                        home: 'Casa',
                        salary: 'Salario',
                        freelance: 'Freelance',
                        investment: 'InversiÃ³n',
                        other: 'Otros'
                    }
                };
                
                return names[this.currentLanguage]?.[categoryKey] || categoryKey;
            }
            
            // Rendering Functions
            renderCurrentSection() {
                switch (this.currentSection) {
                    case 'dashboard':
                        this.renderDashboard();
                        break;
                    case 'transactions':
                        this.renderTransactions();
                        break;
                    case 'budgets':
                        this.renderBudgets();
                        break;
                    case 'goals':
                        this.renderGoals();
                        break;
                    case 'reports':
                        this.renderReports();
                        break;
                    case 'settings':
                        this.renderSettings();
                        break;
                    case 'categories':
                        this.renderCategories();
                        break;
                }
            }
            
            renderDashboard() {
                this.updateDashboardStats();
                this.renderRecentTransactions();
                this.renderCharts();

                // Adiciona o event listener apÃ³s renderizar o dashboard
                const editBtn = document.getElementById('editBalanceBtn');
                if (editBtn) {
                    editBtn.onclick = () => this.openEditBalanceModal();
                }
            }
            
            async updateDashboardStats() {
                const transactions = Array.isArray(this.transactions) ? this.transactions : [];

                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                // MÃªs anterior
                const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

                // Filtros
                const isCurrentMonth = tx => {
                    const d = new Date(tx.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                };
                const isPrevMonth = tx => {
                    const d = new Date(tx.date);
                    return d.getMonth() === prevMonth && d.getFullYear() === prevYear;
                };

                // Totais mÃªs atual
                const totalIncome = transactions.filter(t => t.type === 'income' && isCurrentMonth(t)).reduce((sum, t) => sum + t.amount, 0);
                const totalExpenses = transactions.filter(t => t.type === 'expense' && isCurrentMonth(t)).reduce((sum, t) => sum + t.amount, 0);

                // Totais mÃªs anterior
                const prevIncome = transactions.filter(t => t.type === 'income' && isPrevMonth(t)).reduce((sum, t) => sum + t.amount, 0);
                const prevExpenses = transactions.filter(t => t.type === 'expense' && isPrevMonth(t)).reduce((sum, t) => sum + t.amount, 0);
                const prevBalance = prevIncome - prevExpenses;

                // Saldo inicial manual (se nÃ£o houver, Ã© 0)
                let currentBalance = 0;
                    if (this.manualBalance !== undefined && this.manualBalance !== null && !isNaN(this.manualBalance)) {
                        // Soma/subtrai sÃ³ transaÃ§Ãµes feitas apÃ³s a ediÃ§Ã£o do saldo manual
                        const manualDate = this.manualBalanceDate ? new Date(this.manualBalanceDate) : null;
                        const afterManual = manualDate
                            ? transactions.filter(t => new Date(t.date) > manualDate)
                            : [];
                        const incomeAfter = afterManual.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                        const expenseAfter = afterManual.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                        currentBalance = this.manualBalance + incomeAfter - expenseAfter;
                    } else {
                        // Nunca editou: saldo = receitas - despesas
                        const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
                        const totalExpenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
                        currentBalance = totalIncome - totalExpenses;
                    }

                // FunÃ§Ã£o para calcular variaÃ§Ã£o percentual
                function percentChange(current, prev) {
                    if (prev === 0) return current === 0 ? 0 : 100;
                    return ((current - prev) / Math.abs(prev)) * 100;
                }
                

                // Atualiza os valores
                const elBalance = document.getElementById('currentBalance');
                const elIncome = document.getElementById('monthlyIncome');
                const elExpenses = document.getElementById('monthlyExpenses');

                if (elBalance) elBalance.textContent = this.formatCurrency(currentBalance);
                if (elIncome) elIncome.textContent = this.formatCurrency(totalIncome);
                if (elExpenses) elExpenses.textContent = this.formatCurrency(totalExpenses);

                // Atualiza os percentuais
                const elBalanceChange = document.getElementById('balanceChange');
                const elIncomeChange = document.getElementById('incomeChange');
                const elExpenseChange = document.getElementById('expenseChange');

                if (elBalanceChange) {
                    const pct = percentChange(currentBalance, prevBalance);
                    elBalanceChange.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path></svg>${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
                    elBalanceChange.className = pct >= 0 ? 'text-green-600 dark:text-green-400 flex items-center' : 'text-red-600 dark:text-red-400 flex items-center';
                }
                if (elIncomeChange) {
                    const pct = percentChange(totalIncome, prevIncome);
                    elIncomeChange.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12"></path></svg>${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
                    elIncomeChange.className = pct >= 0 ? 'text-green-600 dark:text-green-400 flex items-center' : 'text-red-600 dark:text-red-400 flex items-center';
                }
                if (elExpenseChange) {
                    const pct = percentChange(totalExpenses, prevExpenses);
                    elExpenseChange.innerHTML = `<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 13l-5 5m0 0l-5-5m5 5V6"></path></svg>${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%`;
                    elExpenseChange.className = pct >= 0 ? 'text-green-600 dark:text-green-400 flex items-center' : 'text-red-600 dark:text-red-400 flex items-center';
                }
            }
            
            renderRecentTransactions() {
                const tableContainer = document.getElementById('recentTransactionsTable');
                const cardsContainer = document.getElementById('recentTransactionsCards');

                const transactions = Array.isArray(this.transactions) ? this.transactions : [];
                const recentTransactions = transactions.slice(0, 5);

                // Caso vazio
                if (recentTransactions.length === 0) {
                    tableContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Nenhuma transaÃ§Ã£o encontrada</p>';
                    cardsContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Nenhuma transaÃ§Ã£o encontrada</p>';
                    return;
                }

                // --- Tabela (Desktop)
                tableContainer.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">DescriÃ§Ã£o</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Categoria</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                ${recentTransactions.map(transaction => `
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                            ${this.formatDate(transaction.date)}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                            ${transaction.description}
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                            <span class="inline-flex items-center">
                                                ${(this.categories.find(cat => cat.id == transaction.category)?.icon || 'ðŸ“¦')}
                                                <span class="ml-2">${(this.categories.find(cat => cat.id == transaction.category)?.name || transaction.category)}</span>
                                            </span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                            ${transaction.type === 'income' ? '+' : '-'}${this.formatCurrency(transaction.amount)}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;

                // --- Cards (Mobile)
                cardsContainer.innerHTML = recentTransactions.map(transaction => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-500 dark:text-gray-300">${this.formatDate(transaction.date)}</span>
                            <span class="text-sm font-medium ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${transaction.type === 'income' ? '+' : '-'}${this.formatCurrency(transaction.amount)}
                            </span>
                        </div>
                        <div class="text-sm text-gray-900 dark:text-white font-semibold mb-1">${transaction.description}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 flex items-center">
                            ${(this.categories.find(cat => cat.id == transaction.category)?.icon || 'ðŸ“¦')}
                            <span class="ml-2">${(this.categories.find(cat => cat.id == transaction.category)?.name || transaction.category)}</span>
                        </div>
                    </div>
                `).join('');
            }


            
            renderTransactions() {
                // Implementation for transactions section
                this.renderTransactionsTable();
                this.setupTransactionFilters();
            }
            
            renderTransactionsTable() {
                const tableContainer = document.getElementById('transactionsTable');
                const cardsContainer = document.getElementById('transactionsCards');

                const filteredTransactions = this.getFilteredTransactions();
                const paginatedTransactions = this.getPaginatedData(filteredTransactions);

                // Nenhuma transaÃ§Ã£o
                if (filteredTransactions.length === 0) {
                    const emptyMsg = '<p class="text-gray-500 dark:text-gray-400 text-center py-8">Nenhuma transaÃ§Ã£o encontrada</p>';
                    tableContainer.innerHTML = emptyMsg;
                    cardsContainer.innerHTML = emptyMsg;
                    return;
                }

                tableContainer.innerHTML = `
                    <div class="overflow-x-auto rounded-lg overflow-hidden">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                        <thead class="bg-gray-50 dark:bg-gray-700">
                            <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">DescriÃ§Ã£o</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Categoria</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Valor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">AÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                            ${paginatedTransactions.map(transaction => `
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${this.formatDate(transaction.date)}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">${transaction.description}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-100">
                                <span class="inline-flex items-center">
                                    ${(this.categories.find(cat => cat.id == transaction.category)?.icon || 'ðŸ“¦')}
                                    <span class="ml-2">${(this.categories.find(cat => cat.id == transaction.category)?.name || transaction.category)}</span>
                                </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${transaction.type === 'income' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                                    ${transaction.type === 'income' ? 'Entrada' : 'SaÃ­da'}
                                </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${transaction.type === 'income' ? '+' : '-'}${this.formatCurrency(transaction.amount)}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <button onclick="app.editTransaction(${transaction.id})" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300 mr-3">Editar</button>
                                <button onclick="app.deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Excluir</button>
                                </td>
                            </tr>
                            `).join('')}
                        </tbody>
                        </table>
                    </div>
                    `;


                // === CARDS (Mobile)
                cardsContainer.innerHTML = paginatedTransactions.map(transaction => `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-sm text-gray-500 dark:text-gray-300">${this.formatDate(transaction.date)}</span>
                            <span class="text-sm font-medium ${transaction.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}">
                                ${transaction.type === 'income' ? '+' : '-'}${this.formatCurrency(transaction.amount)}
                            </span>
                        </div>
                        <div class="text-sm text-gray-900 dark:text-white font-semibold mb-1">${transaction.description}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400 flex items-center mb-1">
                            ${(this.categories.find(cat => cat.id == transaction.category)?.icon || 'ðŸ“¦')}
                            <span class="ml-2">${(this.categories.find(cat => cat.id == transaction.category)?.name || transaction.category)}</span>
                        </div>
                        <div class="text-xs inline-block mb-2 px-2 py-0.5 rounded-full ${transaction.type === 'income' ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'}">
                            ${transaction.type === 'income' ? 'Entrada' : 'SaÃ­da'}
                        </div>
                        <div class="flex justify-end space-x-3 mt-2 text-sm font-medium">
                            <button onclick="app.editTransaction(${transaction.id})" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 dark:hover:text-primary-300">Editar</button>
                            <button onclick="app.deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300">Excluir</button>
                        </div>
                    </div>
                `).join('');

                // Renderiza a paginaÃ§Ã£o
                this.renderPagination(filteredTransactions.length);
            }
            
            setupTransactionFilters() {
                const searchInput = document.getElementById('searchTransactions');
                const categoryFilter = document.getElementById('filterCategory');
                const typeFilter = document.getElementById('filterType');
                
                // Populate category filter
                categoryFilter.innerHTML = `
                    <option value="">${this.t('Todas as Categorias')}</option>
                        ${this.categories.map(cat =>
                            `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
                        ).join('')}
                    `;
                
                // Add event listeners
                [searchInput, categoryFilter, typeFilter].forEach(element => {
                    element.addEventListener('input', () => {
                        this.currentPage = 1;
                        this.renderTransactionsTable();
                    });
                });
            }
            
            getFilteredTransactions() {
                const searchTerm = document.getElementById('searchTransactions')?.value.toLowerCase() || '';
                const categoryFilter = document.getElementById('filterCategory')?.value || '';
                const typeFilter = document.getElementById('filterType')?.value || '';
                
                return this.transactions.filter(transaction => {
                    const matchesSearch = transaction.description.toLowerCase().includes(searchTerm);
                    const matchesCategory = !categoryFilter || transaction.category === categoryFilter;
                    const matchesType = !typeFilter || transaction.type === typeFilter;
                    
                    return matchesSearch && matchesCategory && matchesType;
                });
            }
            
            getPaginatedData(data) {
                const totalPages = Math.ceil(data.length / this.itemsPerPage);
                if (this.currentPage > totalPages) this.currentPage = totalPages || 1;
                const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                return data.slice(startIndex, endIndex);
            }
            
            renderPagination(totalItems) {
                const container = document.getElementById('transactionsPagination');
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);

                if (totalPages <= 1 || totalItems === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="text-sm text-gray-700 dark:text-gray-300">
                            Mostrando ${(this.currentPage - 1) * this.itemsPerPage + 1} a ${Math.min(this.currentPage * this.itemsPerPage, totalItems)} de ${totalItems} resultados
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="app.goToPage(${this.currentPage - 1})" ${this.currentPage === 1 ? 'disabled' : ''} class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                Anterior
                            </button>
                            ${Array.from({ length: totalPages }, (_, i) => i + 1).map(page => `
                                <button onclick="app.goToPage(${page})" class="px-3 py-2 text-sm font-medium ${page === this.currentPage ? 'text-white bg-primary-600 border-primary-600' : 'text-gray-500 bg-white border-gray-300 hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700'} border rounded-md">
                                    ${page}
                                </button>
                            `).join('')}
                            <button onclick="app.goToPage(${this.currentPage + 1})" ${this.currentPage === totalPages ? 'disabled' : ''} class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                PrÃ³xima
                            </button>
                        </div>
                    </div>
                `;
            }
            
            goToPage(page) {
                const totalItems = this.getFilteredTransactions().length;
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                
                if (page >= 1 && page <= totalPages) {
                    this.currentPage = page;
                    this.renderTransactionsTable();
                }
            }
            
            editTransaction(id) {
                const transaction = this.transactions.find(t => t.id === id);
                if (transaction) {
                    this.openTransactionModal(transaction);
                }
            }
            
            async deleteTransaction(id) {
                if (confirm('Tem certeza que deseja excluir esta transaÃ§Ã£o?')) {
                    const ok = await this.deleteTransactionFromSupabase(id);
                    if (ok) {
                        // Recarrega do Supabase para garantir consistÃªncia
                        this.transactions = await this.fetchTransactionsFromSupabase();
                        this.renderCurrentSection();
                        this.showNotification('TransaÃ§Ã£o excluÃ­da com sucesso!', 'success');
                    }
                }
            }
            
            renderBudgets() {
                const container = document.getElementById('budgetsGrid');

                const createCard = `
                    <div onclick="app.openBudgetModal()" class="cursor-pointer bg-white dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-xl flex flex-col items-center justify-center p-6 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                        <div class="text-4xl text-primary-600 dark:text-primary-400 mb-2">+</div>
                        <div class="text-sm font-medium text-gray-700 dark:text-gray-300">Criar novo orÃ§amento</div>
                    </div>
                `;

                if (this.budgets.length === 0) {
                    container.innerHTML = createCard + '<p class="text-gray-500 dark:text-gray-400 text-center py-8 col-span-full">Nenhum orÃ§amento encontrado</p>';
                    return;
                }

                const budgetCards = this.budgets.map(budget => {
                    const spent = this.calculateBudgetSpent(budget.category);
                    const percentage = (spent / budget.limit) * 100;
                    const isOverBudget = spent > budget.limit;

                    return `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">${(this.categories.find(cat => cat.id == budget.category)?.icon || 'ðŸ“¦')}</span>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${(this.categories.find(cat => cat.id == budget.category)?.name || budget.category)}</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${budget.period === 'monthly' ? 'Mensal' : budget.period}</p>
                                    </div>
                                </div>
                                <button onclick="app.deleteBudget(${budget.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>

                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Gasto</span>
                                    <span class="font-medium ${isOverBudget ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-gray-100'}">${this.formatCurrency(spent)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Limite</span>
                                    <span class="font-medium text-gray-900 dark:text-gray-100">${this.formatCurrency(budget.limit)}</span>
                                </div>

                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="h-2 rounded-full transition-all duration-500 ${isOverBudget ? 'bg-red-500' : percentage > 80 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>

                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">${percentage.toFixed(1)}% usado</span>
                                    <span class="font-medium ${isOverBudget ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'}">
                                        ${isOverBudget ? 'Excedido' : this.formatCurrency(budget.limit - spent) + ' restante'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = createCard + budgetCards.join('');
            }

            openGoalModal(goal = null) {
                const isEdit = !!goal;
                const modalId = 'goalModal';

                // Verifica se jÃ¡ existe o modal aberto e remove (para evitar duplicatas)
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 transition-opacity duration-300';

                modal.innerHTML = `
                    <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                                ${isEdit ? 'Editar Meta' : 'Nova Meta'}
                            </h3>
                        </div>
                        <form id="goalForm" class="p-6 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome da Meta</label>
                                <input type="text" name="name" required maxlength="50" value="${goal?.name || ''}"
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="Ex: Viagem dos Sonhos">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Valor Alvo</label>
                                <input type="number" name="target" step="0.01" min="0.01" value="${goal?.target || ''}" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                    placeholder="0,00">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Limite</label>
                                <input type="date" name="deadline" value="${goal?.deadline || new Date().toISOString().split('T')[0]}" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Ãcone (Emoji)</label>
                                <select name="icon" required
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                                    <option value="ðŸŽ¯" ${goal?.icon === 'ðŸŽ¯' ? 'selected' : ''}>ðŸŽ¯ Meta</option>
                                    <option value="ðŸ’°" ${goal?.icon === 'ðŸ’°' ? 'selected' : ''}>ðŸ’° Dinheiro</option>
                                    <option value="ðŸš—" ${goal?.icon === 'ðŸš—' ? 'selected' : ''}>ðŸš— Carro</option>
                                    <option value="ðŸ " ${goal?.icon === 'ðŸ ' ? 'selected' : ''}>ðŸ  Casa</option>
                                    <option value="âœˆï¸" ${goal?.icon === 'âœˆï¸' ? 'selected' : ''}>âœˆï¸ Viagem</option>
                                    <option value="ðŸ“š" ${goal?.icon === 'ðŸ“š' ? 'selected' : ''}>ðŸ“š Estudos</option>
                                    <option value="ðŸŽ‰" ${goal?.icon === 'ðŸŽ‰' ? 'selected' : ''}>ðŸŽ‰ Festa</option>
                                </select>
                            </div>

                            <div class="flex justify-end space-x-3 pt-4">
                                <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    Cancelar
                                </button>
                                <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                    ${isEdit ? 'Atualizar' : 'Salvar'}
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modalsContainer').appendChild(modal);

                // ForÃ§a o fade-in do modal
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    modal.querySelector('.modal-content').classList.remove('scale-95');
                });

                // Evento submit do formulÃ¡rio
                modal.querySelector('#goalForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.saveGoal(goal?.id);
                });
            }
            async saveGoal(goalId) {
                const form = document.getElementById('goalForm');
                const name = form.name.value.trim();
                const icon = form.icon.value;
                const target = parseFloat(form.target.value.replace(',', '.'));
                const deadline = form.deadline.value;

                if (!name || !icon || isNaN(target) || target <= 0 || !deadline) {
                    alert('Preencha todos os campos corretamente!');
                    return;
                }

                // Pegue o usuÃ¡rio autenticado
                const user = (await supabase.auth.getUser()).data.user;
                if (!user) {
                    alert('UsuÃ¡rio nÃ£o autenticado!');
                    return;
                }

                if (goalId) {
                    // Editar meta existente
                    const index = this.goals.findIndex(g => g.id === goalId);
                    if (index !== -1) {
                        const updatedGoal = { ...this.goals[index], name, icon, target, deadline };
                        const ok = await this.updateGoalInSupabase(updatedGoal);
                        if (ok) {
                            this.goals[index] = updatedGoal;
                        }
                    }
                } else {
                    // Nova meta
                    const newGoal = { name, icon, target, current: 0, deadline, user_id: user.id };
                    const ok = await this.addGoalToSupabase(newGoal);
                    if (ok && ok.data && ok.data[0]) {
                        this.goals.push(ok.data[0]);
                    }
                }

                this.renderGoals();
                this.closeModal('goalModal');
            }

            openAddAmountModal(goalId) {
                // Encontre a meta pelo id (assegure que goalId Ã© inteiro)
                const goal = this.goals.find(g => g.id === Number(goalId));
                if (!goal) {
                    alert('Meta nÃ£o encontrada');
                    return;
                }

                const modalId = 'addAmountModal';

                // Cria o conteÃºdo do modal
                const modalContent = `
                    <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
                            <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Adicionar valor Ã  meta "${goal.name}"</h2>
                            <form id="addAmountForm" class="space-y-4">
                                <div>
                                    <label for="amount" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Valor</label>
                                    <input type="number" id="amount" name="amount" min="0.01" step="0.01" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="0,00">
                                    <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                                </div>

                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 border border-transparent rounded-md hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                        Adicionar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;

                // Insere o modal no DOM
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modalWrapper = document.createElement('div');
                modalWrapper.id = modalId;
                modalWrapper.innerHTML = modalContent;
                document.body.appendChild(modalWrapper);

                // Evento submit do form para adicionar valor
                modalWrapper.querySelector('#addAmountForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amountInput = e.target.amount;
                    const amount = parseFloat(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        const errorMessage = amountInput.nextElementSibling;
                        errorMessage.textContent = 'Por favor, insira um valor vÃ¡lido maior que zero.';
                        errorMessage.classList.remove('hidden');
                        return;
                    }

                    // Atualiza o valor atual da meta
                    goal.current = (goal.current || 0) + amount;
                    await this.updateGoalInSupabase(goal);

                    // Cria uma transaÃ§Ã£o de despesa referente Ã  meta
                    const user = (await supabase.auth.getUser()).data.user;
                    const transaction = {
                        type: 'expense',
                        amount: amount,
                        category: 'other', // Ou crie uma categoria especÃ­fica, ex: 'goal'
                        date: new Date().toISOString().split('T')[0],
                        description: `InclusÃ£o de valor na meta ${goal.name}`,
                        user_id: user.id,
                        createdAt: new Date().toISOString()
                    };
                    await this.addTransactionToSupabase(transaction);

                    // Atualiza listas locais
                    this.transactions = await this.fetchTransactionsFromSupabase();
                    this.renderGoals();
                    this.renderCurrentSection();
                    this.closeModal(modalId);
                });

            }

            openWithdrawAmountModal(goalId) {
                const goal = this.goals.find(g => g.id === Number(goalId));
                if (!goal) {
                    alert('Meta nÃ£o encontrada');
                    return;
                }
                const modalId = 'withdrawAmountModal';
                const modalContent = `
                    <div class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-96 p-6 relative">
                            <h2 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Retirar valor da meta "${goal.name}"</h2>
                            <form id="withdrawAmountForm" class="space-y-4">
                                <div>
                                    <label for="amount" class="block mb-1 text-sm font-medium text-gray-700 dark:text-gray-300">Valor</label>
                                    <input type="number" id="amount" name="amount" min="0.01" step="0.01" required
                                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-primary-500 focus:border-transparent"
                                        placeholder="0,00">
                                    <div class="error-message text-red-500 text-sm mt-1 hidden"></div>
                                </div>
                                <div class="flex justify-end space-x-3 pt-4">
                                    <button type="button" onclick="app.closeModal('${modalId}')" class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors">
                                        Cancelar
                                    </button>
                                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-red-600 border border-transparent rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-colors">
                                        Retirar
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                const existingModal = document.getElementById(modalId);
                if (existingModal) existingModal.remove();

                const modalWrapper = document.createElement('div');
                modalWrapper.id = modalId;
                modalWrapper.innerHTML = modalContent;
                document.body.appendChild(modalWrapper);

                modalWrapper.querySelector('#withdrawAmountForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const amountInput = e.target.amount;
                    const amount = parseFloat(amountInput.value);

                    if (isNaN(amount) || amount <= 0) {
                        const errorMessage = amountInput.nextElementSibling;
                        errorMessage.textContent = 'Por favor, insira um valor vÃ¡lido maior que zero.';
                        errorMessage.classList.remove('hidden');
                        return;
                    }
                    if (amount > goal.current) {
                        const errorMessage = amountInput.nextElementSibling;
                        errorMessage.textContent = 'VocÃª nÃ£o pode retirar mais do que o valor atual da meta.';
                        errorMessage.classList.remove('hidden');
                        return;
                    }

                    // Atualiza o valor atual da meta
                    goal.current = (goal.current || 0) - amount;
                    await this.updateGoalInSupabase(goal);

                    // Cria uma transaÃ§Ã£o de receita referente Ã  meta
                    const user = (await supabase.auth.getUser()).data.user;
                    const transaction = {
                        type: 'income',
                        amount: amount,
                        category: 'other', // Ou 'goal'
                        date: new Date().toISOString().split('T')[0],
                        description: `Retirada de valor da meta ${goal.name}`,
                        user_id: user.id,
                        createdAt: new Date().toISOString()
                    };
                    await this.addTransactionToSupabase(transaction);

                    // Atualiza listas locais
                    this.transactions = await this.fetchTransactionsFromSupabase();
                    this.renderGoals();
                    this.renderCurrentSection();
                    this.closeModal(modalId);
                });
            }

            async addAmountToGoal(goalId, amount) {
                const goal = this.goals.find(g => g.id === goalId);
                if (!goal) return;
                goal.current = (goal.current || 0) + amount;
                if (goal.current > goal.target) {
                    goal.current = goal.target;
                    this.showNotification('Valor da meta atingido!', 'success');
                }
                await this.updateGoalInSupabase(goal);
                this.renderGoals();
            }

  
            renderGoals() {
                const container = document.getElementById('goalsGrid');

                if (!container) return;

                const goalCards = this.goals.map(goal => {
                    const percentage = (goal.current / goal.target) * 100;
                    const daysLeft = Math.ceil((new Date(goal.deadline) - new Date()) / (1000 * 60 * 60 * 24));

                    return `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <span class="text-2xl mr-3">${goal.icon}</span>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${goal.name}</h3>
                                        <p class="text-sm text-gray-500 dark:text-gray-400">${daysLeft > 0 ? daysLeft + ' dias restantes' : 'Prazo vencido'}</p>
                                    </div>
                                </div>
                                <button onclick="app.deleteGoal(${goal.id})" class="text-gray-400 hover:text-red-500 transition-colors">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>

                            </div>

                            <div class="space-y-3">
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Atual</span>
                                    <span class="font-medium text-gray-900 dark:text-gray-100">${this.formatCurrency(goal.current)}</span>
                                </div>
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">Meta</span>
                                    <span class="font-medium text-gray-900 dark:text-gray-100">${this.formatCurrency(goal.target)}</span>
                                </div>

                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div class="bg-purple-500 h-2 rounded-full transition-all duration-500" style="width: ${Math.min(percentage, 100)}%"></div>
                                </div>

                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600 dark:text-gray-400">${percentage.toFixed(1)}% concluÃ­do</span>
                                    <span class="font-medium text-purple-600 dark:text-purple-400">
                                        ${percentage >= 100 ? 'ConcluÃ­do' : this.formatCurrency(goal.target - goal.current) + ' restante'}
                                    </span>

                                </div>
                                <div class="mt-4 flex gap-2">
                                    <button onclick="app.openAddAmountModal(${goal.id})" class="text-sm px-3 py-1 bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                                        + Adicionar
                                    </button>
                                    <button onclick="app.openWithdrawAmountModal(${goal.id})" class="text-sm px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition">
                                        - Retirar
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
  
                });

                // Card de Nova Meta
                const addGoalCard = `
                    <div onclick="app.openGoalModal()" class="cursor-pointer flex items-center justify-center bg-white dark:bg-gray-800 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl p-6 text-gray-500 hover:text-purple-600 hover:border-purple-600 transition-all duration-300">
                        <div class="text-center">
                            <div class="text-4xl mb-2">ï¼‹</div>
                            <div class="text-sm font-medium">Nova Meta</div>
                        </div>
                    </div>
                `;

                if (this.goals.length === 0) {
                    container.innerHTML = addGoalCard;
                    return;
                }

                container.innerHTML = [addGoalCard, ...goalCards].join('');
            }

            async deleteGoal(id) {
                if (confirm('Tem certeza que deseja excluir esta meta?')) {
                    const ok = await this.deleteGoalFromSupabase(id);
                    if (ok) {
                        this.goals = this.goals.filter(g => g.id !== id);
                        this.renderGoals();
                        this.showNotification('Meta excluÃ­da com sucesso!', 'success');
                    }
                }
            }
    
            renderReports() {
                // Implementation for reports section
                this.renderReportCharts();
            }
            
            renderReportCharts() {
                const distributionCtx = document.getElementById('distributionChart')?.getContext('2d');
                const monthlyCtx = document.getElementById('monthlyChart')?.getContext('2d');

                // ProteÃ§Ã£o contra mÃºltiplas instÃ¢ncias
                if (this._distributionChart) this._distributionChart.destroy();
                if (this._monthlyChart) this._monthlyChart.destroy();

                // Agrupar receitas e despesas por mÃªs
                const incomeByMonth = {};
                const expenseByMonth = {};

                (this.transactions || []).forEach(tx => {
                    const month = new Date(tx.date).toLocaleString('default', { month: 'short', year: 'numeric' });
                    if (tx.type === 'income') {
                        incomeByMonth[month] = (incomeByMonth[month] || 0) + tx.amount;
                    } else if (tx.type === 'expense') {
                        expenseByMonth[month] = (expenseByMonth[month] || 0) + tx.amount;
                    }
                });

                // Ordenar os meses
                const months = [...new Set([...Object.keys(incomeByMonth), ...Object.keys(expenseByMonth)])].sort(
                    (a, b) => new Date('1 ' + a) - new Date('1 ' + b)
                );
                                
                // === GrÃ¡fico de Linha: Receitas vs Despesas ===
                if (monthlyCtx) {
                    if (this._monthlyChart) this._monthlyChart.destroy();

                    // Meses ordenados
                    const months = [...new Set([
                        ...Object.keys(incomeByMonth),
                        ...Object.keys(expenseByMonth)
                    ])].sort((a, b) => new Date('1 ' + a) - new Date('1 ' + b));

                    // Pega estilos do tema atual
                    const rootStyles = getComputedStyle(document.documentElement);
                    const textColor = rootStyles.getPropertyValue('--text-color').trim() || '#333';
                    const gridColor = rootStyles.getPropertyValue('--grid-color').trim() || '#eee';
                    const tooltipBg = rootStyles.getPropertyValue('--tooltip-bg').trim() || '#222';
                    const tooltipTitle = rootStyles.getPropertyValue('--tooltip-title').trim() || '#fff';
                    const tooltipText = rootStyles.getPropertyValue('--tooltip-text').trim() || '#fff';

                    this._monthlyChart = new Chart(monthlyCtx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Receitas',
                                    data: months.map(m => incomeByMonth[m] || 0),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                    pointBackgroundColor: '#059669',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 5,
                                    pointHoverRadius: 7
                                },
                                {
                                    label: 'Despesas',
                                    data: months.map(m => expenseByMonth[m] || 0),
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.15)',
                                    pointBackgroundColor: '#dc2626',
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 5,
                                    pointHoverRadius: 7
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: textColor,
                                        font: { weight: '600', size: 14 },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: tooltipBg,
                                    titleColor: tooltipTitle,
                                    bodyColor: tooltipText,
                                    cornerRadius: 8,
                                    padding: 10,
                                    callbacks: {
                                        label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: textColor,
                                        font: { size: 13 }
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: textColor,
                                        font: { size: 13 },
                                        callback: value => `R$ ${value.toLocaleString('pt-BR')}`
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                }
                            }
                        }
                    });
                }

                // === GrÃ¡fico de Pizza: DistribuiÃ§Ã£o de Despesas ===
                if (distributionCtx) {
                    if (this._distributionChart) this._distributionChart.destroy();

                    const categoryTotals = {};
                    (this.transactions || []).forEach(tx => {
                        if (tx.type === 'expense') {
                            categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount;
                        }
                    });

                    const labels = Object.keys(categoryTotals).map(cat => (this.categories.find(c => c.id == cat)?.name || cat));
                    const data = Object.values(categoryTotals);
                    const total = data.reduce((sum, val) => sum + val, 0);

                    const palette = [
                        '#3b82f6', '#10b981', '#f59e0b',
                        '#ef4444', '#8b5cf6', '#ec4899', '#0ea5e9'
                    ];

                    // Pegando cores do tema atual
                    const rootStyles = getComputedStyle(document.documentElement);
                    const textColor = rootStyles.getPropertyValue('--text-color').trim() || '#333';
                    const tooltipBg = rootStyles.getPropertyValue('--tooltip-bg').trim() || '#222';
                    const tooltipTitle = rootStyles.getPropertyValue('--tooltip-title').trim() || '#fff';
                    const tooltipText = rootStyles.getPropertyValue('--tooltip-text').trim() || '#fff';

                    this._distributionChart = new Chart(distributionCtx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                backgroundColor: palette,
                                hoverBackgroundColor: palette.map(c => c + 'cc'),
                                borderColor: 'transparent',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            hover: {
                                mode: 'nearest',
                                onHover: (e, elements) => {
                                    e.native.target.style.cursor = elements.length ? 'pointer' : 'default';
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: textColor,
                                        font: { size: 14, weight: '600' },
                                        boxWidth: 14,
                                        padding: 10
                                    }
                                },
                                tooltip: {
                                    backgroundColor: tooltipBg,
                                    titleColor: tooltipTitle,
                                    bodyColor: tooltipText,
                                    cornerRadius: 8,
                                    padding: 12,
                                    callbacks: {
                                        label: ctx => {
                                            const value = ctx.parsed;
                                            const percent = ((value / total) * 100).toFixed(1);
                                            return `${ctx.label}: R$ ${value.toLocaleString('pt-BR')} (${percent}%)`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [
                            {
                                id: 'hoverGlow',
                                afterDatasetDraw(chart) {
                                    const { ctx } = chart;
                                    const activeElements = chart.getActiveElements();
                                    if (activeElements.length > 0) {
                                        const { index, datasetIndex } = activeElements[0];
                                        const meta = chart.getDatasetMeta(datasetIndex);
                                        const arc = meta.data[index];
                                        ctx.save();
                                        ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                                        ctx.shadowBlur = 20;
                                        arc.draw(ctx);
                                        ctx.restore();
                                    }
                                }
                            },
                            {
                                id: 'centerText',
                                beforeDraw(chart) {
                                    const { ctx, width, height } = chart;
                                    ctx.save();

                                    // Total formatado
                                    const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                    const formattedTotal = `R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

                                    // Estilos
                                    ctx.font = '700 20px "Helvetica Neue", Helvetica, Arial, sans-serif';
                                    ctx.fillStyle = textColor;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.shadowColor = 'rgba(0,0,0,0.1)';
                                    ctx.shadowBlur = 10;
                                    ctx.shadowOffsetX = 0;
                                    ctx.shadowOffsetY = 2;

                                    ctx.fillText(formattedTotal, width / 2, height / 2);

                                    ctx.restore();
                                }
                            }
                        ]
                    });
                }
            }
            
            renderSettings() {
                // Settings are already rendered in HTML, just update values
                const themeSelect = document.getElementById('themeSelect');
                const languageSelect = document.getElementById('settingsLanguage');
                const currencySelect = document.getElementById('defaultCurrency');
                
                if (themeSelect) themeSelect.value = this.currentTheme;
                if (languageSelect) languageSelect.value = this.currentLanguage;
                if (currencySelect) currencySelect.value = localStorage.getItem('defaultCurrency') || 'BRL';
            }
            
            renderCharts() {
                const incomeExpenseCanvas = document.getElementById('incomeExpenseChart');
                const categoryCanvas = document.getElementById('categoryChart');

                if (this._incomeExpenseChart) this._incomeExpenseChart.destroy();
                if (this._categoryChart) this._categoryChart.destroy();

                const now = new Date();
                const months = Array.from({ length: 6 }, (_, i) => {
                    const d = new Date(now.getFullYear(), now.getMonth() - 5 + i, 1);
                    return d.toLocaleString('default', { month: 'short' }) + '/' + d.getFullYear().toString().slice(-2);
                });

                const incomeByMonth = new Array(6).fill(0);
                const expenseByMonth = new Array(6).fill(0);

                (this.transactions || []).forEach(tx => {
                    const date = new Date(tx.date);
                    const index = 5 - (now.getMonth() - date.getMonth()) - 12 * (now.getFullYear() - date.getFullYear());
                    if (index >= 0 && index < 6) {
                        if (tx.type === 'income') incomeByMonth[index] += tx.amount;
                        if (tx.type === 'expense') expenseByMonth[index] += tx.amount;
                    }
                });

                // === GrÃ¡fico de Linha: Receitas vs Despesas ===
                if (incomeExpenseCanvas) {
                    const ctx = incomeExpenseCanvas.getContext('2d');
                    if (this._incomeExpenseChart) this._incomeExpenseChart.destroy();

                    // Captura valores das variÃ¡veis CSS
                    const rootStyles = getComputedStyle(document.documentElement);
                    const textColor = rootStyles.getPropertyValue('--text-color').trim() || '#333';
                    const gridColor = rootStyles.getPropertyValue('--grid-color').trim() || '#eee';
                    const tooltipBg = rootStyles.getPropertyValue('--tooltip-bg').trim() || '#222';
                    const tooltipTitle = rootStyles.getPropertyValue('--tooltip-title').trim() || '#fff';
                    const tooltipText = rootStyles.getPropertyValue('--tooltip-text').trim() || '#fff';

                    this._incomeExpenseChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Receitas',
                                    data: incomeByMonth,
                                    borderColor: '#10b981', // success-500
                                    backgroundColor: 'rgba(16, 185, 129, 0.15)',
                                    pointBackgroundColor: '#059669', // success-600
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 5,
                                    pointHoverRadius: 7
                                },
                                {
                                    label: 'Despesas',
                                    data: expenseByMonth,
                                    borderColor: '#ef4444', // danger-500
                                    backgroundColor: 'rgba(239, 68, 68, 0.15)',
                                    pointBackgroundColor: '#dc2626', // danger-600
                                    fill: true,
                                    tension: 0.4,
                                    pointRadius: 5,
                                    pointHoverRadius: 7
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                mode: 'index',
                                intersect: false
                            },
                            plugins: {
                                legend: {
                                    labels: {
                                        color: textColor,
                                        font: { weight: '600', size: 14 },
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: tooltipBg,
                                    titleColor: tooltipTitle,
                                    bodyColor: tooltipText,
                                    cornerRadius: 8,
                                    padding: 10,
                                    callbacks: {
                                        label: ctx => `R$ ${ctx.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: {
                                        color: textColor,
                                        font: { size: 13 }
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                },
                                y: {
                                    ticks: {
                                        color: textColor,
                                        font: { size: 13 },
                                        callback: value => `R$ ${value.toLocaleString('pt-BR')}`
                                    },
                                    grid: {
                                        color: gridColor
                                    }
                                }
                            }
                        }
                    });
                }


                // === GrÃ¡fico de Pizza: DistribuiÃ§Ã£o de Despesas ===
                if (categoryCanvas) {
                    const ctx = categoryCanvas.getContext('2d');
                    if (this._categoryChart) this._categoryChart.destroy();

                    const categoryTotals = {};
                    (this.transactions || []).forEach(tx => {
                        if (tx.type === 'expense') {
                            categoryTotals[tx.category] = (categoryTotals[tx.category] || 0) + tx.amount;
                        }
                    });

                    const labels = Object.keys(categoryTotals).map(cat => (this.categories.find(c => c.id == cat)?.name || cat));
                    const data = Object.values(categoryTotals);
                    const total = data.reduce((sum, val) => sum + val, 0);

                    const palette = [
                        '#3b82f6', '#10b981', '#f59e0b',
                        '#ef4444', '#8b5cf6', '#ec4899', '#0ea5e9'
                    ];

                    // Pega as cores do tema atual (dark/light)
                    const rootStyles = getComputedStyle(document.documentElement);
                    const textColor = rootStyles.getPropertyValue('--text-color').trim() || '#333';
                    const tooltipBg = rootStyles.getPropertyValue('--tooltip-bg').trim() || '#222';
                    const tooltipTitle = rootStyles.getPropertyValue('--tooltip-title').trim() || '#fff';
                    const tooltipText = rootStyles.getPropertyValue('--tooltip-text').trim() || '#fff';

                    this._categoryChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                backgroundColor: palette,
                                hoverBackgroundColor: palette.map(c => c + 'cc'),
                                borderColor: 'transparent',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            animation: {
                                animateRotate: true,
                                animateScale: true,
                                duration: 1000,
                                easing: 'easeOutQuart'
                            },
                            hover: {
                                mode: 'nearest',
                                onHover: (e, elements) => {
                                    const el = e.native?.target;
                                    if (el) el.style.cursor = elements.length ? 'pointer' : 'default';
                                }
                            },
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        color: textColor,
                                        font: { size: 14, weight: '600' },
                                        boxWidth: 14,
                                        padding: 10
                                    }
                                },
                                tooltip: {
                                    backgroundColor: tooltipBg,
                                    titleColor: tooltipTitle,
                                    bodyColor: tooltipText,
                                    cornerRadius: 8,
                                    padding: 12,
                                    callbacks: {
                                        label: ctx => {
                                            const value = ctx.parsed;
                                            const percent = ((value / total) * 100).toFixed(1);
                                            return `${ctx.label}: R$ ${value.toLocaleString('pt-BR')} (${percent}%)`;
                                        }
                                    }
                                }
                            }
                        },
                        plugins: [
                            {
                                id: 'hoverGlow',
                                afterDatasetDraw(chart) {
                                    const { ctx } = chart;
                                    const activeElements = chart.getActiveElements();
                                    if (activeElements.length > 0) {
                                        const { index, datasetIndex } = activeElements[0];
                                        const meta = chart.getDatasetMeta(datasetIndex);
                                        const arc = meta.data[index];

                                        ctx.save();
                                        ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                                        ctx.shadowBlur = 20;
                                        arc.draw(ctx);
                                        ctx.restore();
                                    }
                                }
                            },
                            {
                                id: 'centerText',
                                beforeDraw(chart) {
                                    const { ctx, width, height } = chart;
                                    ctx.save();

                                    // Total calculado e formatado
                                    const total = chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                                    const formattedTotal = `R$ ${total.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}`;

                                    // Cores e estilos do tema, com fallback
                                    const color = textColor;
                                    const shadowColor = 'rgba(0,0,0,0.1)';

                                    // Fonte e sombra para o valor principal (maior)
                                    ctx.font = '700 20px "Helvetica Neue", Helvetica, Arial, sans-serif';
                                    ctx.fillStyle = color;
                                    ctx.textAlign = 'center';
                                    ctx.textBaseline = 'middle';
                                    ctx.shadowColor = shadowColor;
                                    ctx.shadowBlur = 10;
                                    ctx.shadowOffsetX = 0;
                                    ctx.shadowOffsetY = 2;
                                
                                    ctx.restore();
                                }
                            }
                        ]
                    });
                }

                const observer = new MutationObserver(() => {
                    app.renderCharts?.();
                });
                observer.observe(document.documentElement, { attributes: true, attributeFilter: ['class'] });

            }
            
            exportToPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const incomeData = [];
                const expenseData = [];

                (this.transactions || []).forEach(tx => {
                    const row = [
                        this.formatDate(tx.date),
                        (this.categories.find(c => c.id == tx.category)?.name || tx.category),
                        `R$ ${tx.amount.toFixed(2).replace('.', ',')}`
                    ];

                    if (tx.type === 'income') incomeData.push(row);
                    else if (tx.type === 'expense') expenseData.push(row);
                });

                doc.setFontSize(18);
                doc.text("RelatÃ³rio Financeiro", 14, 20);

                // Receitas
                doc.setFontSize(14);
                doc.text("Entradas (Receitas)", 14, 30);
                doc.autoTable({
                    startY: 35,
                    head: [["Data", "Categoria", "Valor"]],
                    body: incomeData,
                    styles: { fontSize: 11 }
                });

                // Despesas
                let finalY = doc.lastAutoTable.finalY + 10;
                doc.text("SaÃ­das (Despesas)", 14, finalY);
                doc.autoTable({
                    startY: finalY + 5,
                    head: [["Data", "Categoria", "Valor"]],
                    body: expenseData,
                    styles: { fontSize: 11 }
                });

                doc.save("Relatorio_Financeiro.pdf");
            }

            exportToCSV() {
                const rows = [["Tipo", "Data", "Categoria", "Valor"]];
                
                (this.transactions || []).forEach(tx => {
                    rows.push([
                        tx.type === 'income' ? "Receita" : "Despesa",
                        this.formatDate(tx.date),
                        (this.categories.find(c => c.id == tx.category)?.name || tx.category),
                        tx.amount.toFixed(2).replace('.', ',')
                    ]);
                });

                const csvContent = rows.map(e => e.join(";")).join("\n");
                const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });

                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = "transacoes.csv";
                link.click();
            }

            formatDate(dateStr) {
                const d = new Date(dateStr);
                return d.toLocaleDateString('pt-BR');
            }

            // ...dentro da classe FinanceApp...
            async deleteBudget(id) {
                if (!id) {
                    this.showNotification('ID do orÃ§amento invÃ¡lido', 'error');
                    return;
                }
                if (confirm('Tem certeza que deseja excluir este orÃ§amento?')) {
                    const { error } = await supabase.from('budgets').delete().eq('id', id);
                    if (error) {
                        this.showNotification('Erro ao excluir orÃ§amento no servidor', 'error');
                        return;
                    }
                    this.budgets = this.budgets.filter(b => b.id !== id);
                    this.renderBudgets();
                    this.showNotification('OrÃ§amento excluÃ­do com sucesso!', 'success');
                }
            }
            
            // Utility Functions
            handleResize() {
                // Handle responsive behavior
                if (window.innerWidth >= 1024) {
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                    document.getElementById('sidebarOverlay').classList.add('hidden');
                }
            }
            
            updateReportCharts() {
                const typeFilter = document.getElementById("reportType").value;

                const filteredTransactions = this.transactions.filter(tx => {
                    if (!typeFilter) return true;
                    return tx.type === typeFilter;
                });

                this.renderReportCharts(filteredTransactions);
            }

            
        }
        
        // Alternar entre login e cadastro
        document.addEventListener('DOMContentLoaded', async () => {
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const openRegisterBtn = document.getElementById('openRegisterBtn');
            const backToLoginBtn = document.getElementById('backToLoginBtn');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const loginError = document.getElementById('loginError');
            const registerError = document.getElementById('registerError');
            const loginEmail = document.getElementById('loginEmail');
            const loginPassword = document.getElementById('loginPassword');

            // FunÃ§Ã£o para limpar campos do login
            function clearLoginFields() {
                if (loginEmail) loginEmail.value = '';
                if (loginPassword) loginPassword.value = '';
            }

            // Alternar modais
            if (openRegisterBtn) openRegisterBtn.onclick = () => {
                loginModal.classList.remove('flex');
                registerModal.classList.add('flex');
                registerError.classList.add('hidden');
                if (registerForm) registerForm.reset();
            };
            if (backToLoginBtn) backToLoginBtn.onclick = (e) => {
                e.preventDefault();
                registerModal.classList.remove('flex');
                loginModal.classList.add('flex');
                loginError.classList.add('hidden');
                clearLoginFields();
            };

            // Cadastro
            if (registerForm) {
                registerForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('registerName').value.trim();
                    const email = document.getElementById('registerEmail').value.trim();
                    const password = document.getElementById('registerPassword').value;
                    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
                    registerError.classList.add('hidden');

                    if (!name || !email || !password || !passwordConfirm) {
                        registerError.textContent = 'Preencha todos os campos.';
                        registerError.classList.remove('hidden');
                        return;
                    }
                    if (password !== passwordConfirm) {
                        registerError.textContent = 'As senhas nÃ£o coincidem.';
                        registerError.classList.remove('hidden');
                        return;
                    }
                    if (password.length < 6) {
                        registerError.textContent = 'A senha deve ter pelo menos 6 caracteres.';
                        registerError.classList.remove('hidden');
                        return;
                    }

                    const { error } = await supabase.auth.signUp({
                        email,
                        password,
                        options: { data: { full_name: name } }
                    });
                    if (error) {
                        registerError.textContent = error.message;
                        registerError.classList.remove('hidden');
                    } else {
                        registerModal.classList.remove('flex');
                        loginModal.classList.add('flex');
                        loginError.classList.add('hidden');
                        registerForm.reset();
                        clearLoginFields();
                        alert('Cadastro realizado! FaÃ§a login para acessar.');
                    }
                };
            }

            // Login
            if (loginForm) {
                loginForm.onsubmit = async (e) => {
                    e.preventDefault();
                    const email = loginEmail.value.trim();
                    const password = loginPassword.value;
                    loginError.classList.add('hidden');

                    const { error } = await supabase.auth.signInWithPassword({ email, password });
                    if (error) {
                        loginError.textContent = 'E-mail ou senha invÃ¡lidos.';
                        loginError.classList.remove('hidden');
                    } else {
                        loginModal.classList.remove('flex');
                        document.body.classList.remove('login-active');
                        window.app = new FinanceApp();
                    }
                };
            }

            // Verifica se estÃ¡ logado
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                if (loginModal) loginModal.classList.remove('flex');
                if (registerModal) registerModal.classList.remove('flex');
                document.body.classList.remove('login-active');
                window.app = new FinanceApp();
            } else {
                if (loginModal) loginModal.classList.add('flex');
                if (registerModal) registerModal.classList.remove('flex');
                document.body.classList.add('login-active');
                clearLoginFields();
            }
        });
</script>
</body>